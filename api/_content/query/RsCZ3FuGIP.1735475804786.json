{"_path":"/posts/non-interactive-router-reboot-howto","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"Non-interactive router reboot HOWTO","description":"How to reboot a home router automatically and/or non-interactively","imagesource":"https://commons.wikimedia.org/wiki/File:WRT54G_v2_Linksys_Router_Digon3.jpg","imagecredit":"Jonathan Zander","image":"2009.04.07T140000_non-interactive-router-reboot-howto.jpg","createdAt":"2009-04-07T14:00:00","updatedAt":"2009-04-07T14:00:00","readingTime":{"text":"1 min read","minutes":0.34,"time":20400,"words":68},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Hi everyone!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I've recently been having trouble with a router getting all bunged up due to the high levels of data passing through it. Invariably, I come in in the morning and we've lost access to the Internet from some of our stations until I've rebooted it. While I'm in the process of building a routing box for the network, I wanted to know if I could automagically have the router reboot itself well before anyone would be wanting access."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As with almost EVERYTHING Linux oriented, the answer is OF COURSE I CAN!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There's a nifty little utility within Linux called "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"expect"}]},{"type":"text","value":". It comes as standard with Slackware, so no installation needed for me. It allows pre-programmed non-interactive access to normally interactive shells. The script I've written looks like this:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"#!/usr/bin/expect -f\nset address [lindex $argv 0]\nset username [lindex $argv 1]\nset password  [lindex $argv 2]\nset routercmd [lindex $argv 3]\nspawn telnet $address\nexpect \"Login:\"\nsend -- \"$username\\r\"\nexpect \"Password:\"\nsend -- \"$password\\r\"\n# This command gets us out of the default menu and into a shell\nexpect \"&amp;gt; \"\nsend -- \"sh\\r\"\nexpect \"# \"\nsend -- \"$routercmd\\r\"\n#exit\nsend -- \"^D\"\nsend -- \"^D\"\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"#!/usr/bin/expect -f\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"set"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" address"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" [lindex $argv "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"0]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"set"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" username"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" [lindex $argv "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"1]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"set"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" password"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"  [lindex $argv "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"2]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"set"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" routercmd"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" [lindex $argv "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"3]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"spawn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" telnet"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" $address\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"expect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"Login:\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"send"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"$username"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\\r\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"expect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"Password:\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"send"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"$password"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\\r\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"# This command gets us out of the default menu and into a shell\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"expect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"&amp;gt; \"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"send"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"sh\\r\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"expect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"# \"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"send"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"$routercmd"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\\r\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"#exit\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"send"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"^D\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"send"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"^D\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As you can see, expect is used as the script handler with the -f flag, which would usually point to a script file to be run."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The script really is incredibly simple..."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It takes 4 arguments in this order:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"address"}]},{"type":"text","value":" - The router's IP,"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"username"}]},{"type":"text","value":" - The router's admin username"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"password"}]},{"type":"text","value":" - The router's admin password"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"routercmd"}]},{"type":"text","value":" - The command which you wish to run"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In my case, I've set up a cron job to run daily at 4.40am (the default for cron.daily) which runs the command "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/usr/local/bin/routercommand.exp 192.168.1.1 **username** **password** reboot"}]},{"type":"text","value":". I am yet to see whether 4.40am is suitable, but it's a step in the right direction!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Anyway, I hope this has been of interest or maybe even use!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"n00b"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"UPDATE - 09/04/09"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This has completely fixed our problems with the router. We have seen flawless behaviour since. Whoo! Now if I could only get Smoothwall doing PPPoA with the router in bridge mode! Any ideas would be very helpful!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"n00b"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"UPDATE - 24/04/09"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It seems that all of these modem/routers which claim to fully support bridge mode are at best exaggerating. The best results it is apparent that you can expect is intermittency, which is TOTALLY USELESS in a production environment. The way forward is using a true PPPoA to PPPoE bridge modem. I'm using a Draytek Vigor 110, because by all accounts it ACTUALLY WORKS (shock, horror!)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Anyway... Just thought I'd feed you all that useful little nugget of knowledge. Hopefully I've saved even one person from losing sleep over it."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"n00b"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:posts:2009-04-07-non-interactive-router-reboot-howto.md","_source":"content","_file":"posts/2009-04-07-non-interactive-router-reboot-howto.md","_stem":"posts/2009-04-07-non-interactive-router-reboot-howto","_extension":"md"}