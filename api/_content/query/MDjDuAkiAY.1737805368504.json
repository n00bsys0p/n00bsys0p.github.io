{"_path":"/posts/postfix-and-courier-imap-authentication-mysql-using-courier","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"Postfix and Courier IMAP Authentication via MySQL using Courier","description":"IMAP e-mail server using MySQL for authentication","imagesource":null,"imagecredit":null,"imageFilename":"2011.08.09T140000_postfix-and-courier-imap-authentication-mysql-using-courier.png","createdAt":"2011-08-09T14:00:00","updatedAt":"2011-08-09T14:00:00","readingTime":{"text":"5 min read","minutes":4.215,"time":252900,"words":843},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Hi guys!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I've been working on making a Postfix server authenticate using encrypted passwords in a MySQL database. This seemed, by all accounts, and the number of How-To guides online, to be a pretty simple job. I seriously couldn't have been more wrong. The majority of the guides worked without a hitch... Courier IMAP connected straight up, without a hitch, but Postfix simply refused to. The case seemed to be (from reading online about it), that saslauthd's auxprop SQL driver doesn't like passwords being stored in an encrypted form. For modern software, this is absolutely absurd, if you ask me. Nevertheless, after multiple days tearing my hair out, I thought to myself \"Why am I using two different auth mechanisms? Can I use Courier's Authdaemon, which works fine with Courier IMAP, to authenticate Postfix too?\". The answer is absolutely yes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is how I did it:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first step, was to use the following guide, and a couple of others available online as a basepoint, without adding any of the user interface tools, and changing the layout of the email tables somewhat, to better fit my own purpose: "},{"type":"element","tag":"a","props":{"href":"http://flurdy.com/docs/postfix/","target":"_blank"},"children":[]},{"type":"element","tag":"a","props":{"href":"http://flurdy.com/docs/postfix/","rel":["nofollow"]},"children":[{"type":"text","value":"http://flurdy.com/docs/postfix/"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once, however, I got to the section about using saslauthd via pam to authenticate your SMTP server, it rapidly became impossible to complete. No matter if the guide is followed to the letter, you may well still end up with authentication problems. The specific problem I had, was that saslauthd wouldn't seem to query my SQL server. All I ever saw in the SQL debug logs was logins, and the server quitting again, without querying the db at all. Needless to say, this was pretty seriously frustrating, as I could find little to no help online, and whenever I found something relevant, the only answers were something to the effect of \"LOL, give up - Postfix sucks\"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As I previously mentioned, the IMAP server was working without fault, so I could only assume that Courier-Authdaemon was doing its job perfectly, and sure enough, when I checked the auth and mysql debug logs, I could see that it was successfully querying the db, and authenticating my mail user correctly. It is a pretty simple job to make postfix use authdaemond to authenticate, too."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first step is to fill out the following information into saslauthd's smtpd.conf. This may be found in one of a few places, including "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/etc/sasl2/"}]},{"type":"text","value":", "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/usr/lib/sasl2/"}]},{"type":"text","value":", and "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/etc/postfix/sasl/"}]},{"type":"text","value":". Find your distribution's copy, and paste in the following:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"pwcheck_method: authdaemond\nmech_list: PLAIN LOGIN\nauthdaemond_path: /var/run/courier/authdaemon/socket\n\nauxprop_plugin: mysql\nsql_select: select stuff from things where user = '%u';\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"pwcheck_method:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" authdaemond\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"mech_list:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" PLAIN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" LOGIN\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"authdaemond_path:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" /var/run/courier/authdaemon/socket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"auxprop_plugin:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" mysql\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"sql_select:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" select"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" stuff"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" things"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" where"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" user"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" '%u'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":";\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note that the last two lines there serve to achieve absolutely nothing, but stop saslauthd whinging and filling your logs with stuff about not having them configured. Now if you've followed Postfix's security guidelines, you will have left it in its chroot jail. If not, I hope you have a damn good reason for having taken it out, as it means that if your mail system is compromised, it's far less likely that the rest of your machine is at risk."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"have"}]},{"type":"text","value":" left it in its jail, you will find that you still can't authenticate, as Postfix starts shouting about not being able to find the Courier-Authdaemon socket to connect to. This is quite right, as the socket is located outside of Postfix's jail. You probably can't hard link, as /var/run is a different partition to /, and symlinking from within the chroot jail will fail, as the folder you want to symlink to is located outside it, so it can't see it. I found a nifty way to do this "},{"type":"element","tag":"a","props":{"href":"http://www.thelazysysadmin.net/2009/08/cannot-connect-to-courier-authdaemond-no-such-file-or-directory/","target":"_blank"},"children":[{"type":"text","value":"here"}]},{"type":"text","value":". I'll detail the content as follows."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note: Before you do this, make sure that before you stop the courier-authdaemon, you check which folder on your Linux system contains the authdaemon socket. You will be able to find this by using the command "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"lsof -n | grep authdaemon"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, you need to stop the Courier-Authdaemon. This depends on your OS, but on Ubuntu, you will run "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/etc/init.d/courier-authdaemon stop"}]},{"type":"text","value":". Now you need to remove the folder in which the socket is normally created:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"rm -rf /var/run/courier/authdaemon/\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"rm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" -rf"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" /var/run/courier/authdaemon/\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You now need to symlink the folder outside the chroot to the folder inside. This means that courier's authdaemon, which is running outside the chroot, will unwittingly be putting its socket in a folder within Postfix's chroot, while it doesn't see any difference from the way in which it originally did so. First, make sure the folder you're symlinking to exists, then put the symlink in place:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"mkdir -p /var/spool/postfix/var/run/courier/authdaemon/\nln -s /var/spool/postfix/var/run/courier/authdaemon/ /var/run/courier/authdaemon\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"mkdir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" -p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" /var/spool/postfix/var/run/courier/authdaemon/\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"ln"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" -s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" /var/spool/postfix/var/run/courier/authdaemon/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" /var/run/courier/authdaemon\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now start Courier-Authdaemon again, and if you check /var/spool/postfix/var/run/courier/authdaemon, you will see that in there is the file we pointed it to, in the sasl smtpd.conf."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now restart Postfix, and you will hopefully be able to authenticate to SMTP, and send messages without a problem."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If anybody has experienced this same problem, and has any other resolution for it, I'd be intrigued to see how it has been done, or yet again, if anybody has any questions, either direct them to me in the comments, or if you'd prefer to contact me privately, just fill out the form on my contact page!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"n00b"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:posts:2011-08-09-postfix-and-courier-imap-authentication-mysql-using-courier.md","_source":"content","_file":"posts/2011-08-09-postfix-and-courier-imap-authentication-mysql-using-courier.md","_stem":"posts/2011-08-09-postfix-and-courier-imap-authentication-mysql-using-courier","_extension":"md"}