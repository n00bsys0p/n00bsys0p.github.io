{"_path":"/posts/varnish-301-redirects-ssl-load-balancer-www-htaccess","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"301s, Drupal, Varnish, and SSL Load Balancers","description":"How to get SSL-only sites working behind load balancers and Varnish","imagesource":"https://commons.wikimedia.org/wiki/File:22_ft_Spencer_Runabout.jpg","imagecredit":"Mwanner","image":"2015.10.04T060000_varnish-301-redirects-ssl-load-balancer-www-htaccess.png","createdAt":"2015-10-04T06:00:00","updatedAt":"2015-10-04T06:00:00","readingTime":{"text":"1 min read","minutes":0.22,"time":13200,"words":44},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Hi all,"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Today I'm just going to provide a snippet that I used when trying to handle Varnish caching, when a client required a Drupal install in front of a platform that had Varnish over Apache, all behind a cloud SSL load balancer. The client needed not only to redirect all raw domain requests requests to \"www\", but also to redirect all non-https to their HTTPS equivalent."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This seemed to work pretty well straight out of the box, by just setting the $base_url variable in the Drupal settings file to point to the HTTPS domain and setting up a Rewrite in the .htaccess. It was only when we cleared the cache that things started to go awry."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The www redirect was exactly as you'd expect, uncommented character for character in the default Drupal .htaccess file. The SSL redirect was a custom entry implemented as follows:"}]},{"type":"element","tag":"pre","props":{"code":"RewriteCond %{HTTP:X-Forwarded-Proto} !=https\nRewriteRule .* https://%{HTTP_HOST}/%{REQUEST_URI} [R=301, L]\n","language":"apache","meta":"","className":"language-apache shiki shiki-themes github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"RewriteCond"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#DBEDFF"},"children":[{"type":"text","value":" %{HTTP:X-Forwarded-Proto}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" !=https\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"RewriteRule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#DBEDFF"},"children":[{"type":"text","value":" .*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" https://%{HTTP_HOST}/%{REQUEST_URI}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" [R="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"301"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", L]\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"X-Forwarded-Proto is the de-facto standard header forwarded by SSL-compatible load balancers. There's no RFC that states it, but it's been adopted by all the major providers, so you're generally going to be pretty safe assuming it's there."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The problem was, when we cleared the Varnish cache (which happened automatically on an unattended deploy), "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"and"}]},{"type":"text","value":" the first view to the page was accessed via HTTP, which it would be for any clients who just typed the URL into their browser, Varnish hashed the content of the page as being nothing but a redirect. Needless to say this completely broke everything! The site just went into a redirect loop."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This could have been resolved with complex iptables rules, or any number of other smart but unnecessary solutions. Instead, we chose to add the X-Forwarded-Proto header to the Varnish hash. To do this, just a couple of lines needed adding to our "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"/etc/varnish/default.vcl"}]},{"type":"text","value":". Because it's a shared hosting server with various sites and configurations on it, we elected to restrict this modification to JUST the site in question, and came up with the something resembling the following:"}]},{"type":"element","tag":"pre","props":{"code":"sub vcl_hash {\n    hash_data(req.url);\n\n    # Begin SSL load balancer config\n    if (req.url ~ \"www.mydomain.url\" &amp;&amp; req.http.X-Forwarded-For) {\n        hash_data(req.http.X-Forwarded-For);\n    }\n    # End SSL load balancer config\n\n    if (req.http.host) {\n        hash_data(req.http.host);\n    } else {\n        hash_data(server.ip);\n    }\n\n    return (lookup);\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"sub vcl_hash {\n    hash_data(req.url);\n\n    # Begin SSL load balancer config\n    if (req.url ~ \"www.mydomain.url\" &amp;&amp; req.http.X-Forwarded-For) {\n        hash_data(req.http.X-Forwarded-For);\n    }\n    # End SSL load balancer config\n\n    if (req.http.host) {\n        hash_data(req.http.host);\n    } else {\n        hash_data(server.ip);\n    }\n\n    return (lookup);\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This means that Varnish will store two different caches. One for requests which came in via HTTP, and another via HTTPS. In this case, the only thing that would be cached for the HTTP side of things is the redirect to the secure site. Always consider the impact this will have on your cached data storage before making changes like this, particularly if the server hosts more than one site."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:posts:2015-10-04-varnish-301-redirects-ssl-load-balancer-www-htaccess.md","_source":"content","_file":"posts/2015-10-04-varnish-301-redirects-ssl-load-balancer-www-htaccess.md","_stem":"posts/2015-10-04-varnish-301-redirects-ssl-load-balancer-www-htaccess","_extension":"md"}