{"_path":"/posts/faking-firebase-admin-in-tests","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"Faking Firebase initialisation in Tests","description":"How to fake Firebase SDK initialisation in your Python app's test suite","imagesource":"https://firebase.google.com/brand-guidelines","imagecredit":"Google LLC","imageFilename":"2024.11.23T211300_mocking-firebase-admin-in-tests.png","createdAt":"2024-11-23T21:13:00","updatedAt":"2024-11-23T21:13:00","readingTime":{"text":"2 min read","minutes":1.63,"time":97800,"words":326},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Unit and/or acceptance testing is as we all know, critical to application performance. So many applications\nuse 3rd party services as their backend, but we still need to be able to run our test suites, without blowing\nout our billing, or slowing down our tests inordinately."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In a project I've been working on, we had end-to-end tests in which the application was spun up by a DI\ncontainer, which initialised Firebase as part of its initialisation. Various endpoints in the application\ndepended on the default Firebase app being initialised by the time that they were called, and would throw\na ValueError with the message \"The default Firebase app does not exist. Make sure to initialize the SDK by\ncalling initialize_app().\" if we just skipped Firebase initialisation. We had to figure out a way to convince\nthe Python Firebase Admin SDK that it was initialised, without having to configure any legitimate Firebase\ncredentials in our testing environment."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To initialise the Firebase Admin SDK, we use the "},{"type":"element","tag":"a","props":{"href":"https://firebase.google.com/docs/reference/admin/python/firebase_admin","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"firebase_admin.initialize_app"}]}]},{"type":"text","value":"\nmethod. This method takes a credential object, which must be an instance of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"firebase_admin.credentials.Base"}]},{"type":"text","value":",\nand an options dictionary. Looking at the\n"},{"type":"element","tag":"a","props":{"href":"https://github.com/firebase/firebase-admin-python/blob/8ba819a4175e758576f1a7cccc131c1b66d6417a/tests/testutils.py#L127-L134","rel":["nofollow"]},"children":[{"type":"text","value":"Firebase Admin SDK's own test suite"}]},{"type":"text","value":",\nit initialises the SDK by passing in a custom subclass of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"firebase_admin.credentials.Base"}]},{"type":"text","value":", which extends\nit with the minimal possible configuration. From that file:"}]},{"type":"element","tag":"pre","props":{"className":"language-python shiki shiki-themes github-dark","code":"class MockCredential(firebase_admin.credentials.Base):\n    \"\"\"A mock Firebase credential implementation.\"\"\"\n\n    def __init__(self):\n        self._g_credential = MockGoogleCredential()\n\n    def get_credential(self):\n        return self._g_credential\n","language":"python","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" MockCredential"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"firebase_admin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"credentials"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"Base"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"    \"\"\"A mock Firebase credential implementation.\"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" __init__"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"(self):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"._g_credential "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" MockGoogleCredential()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" get_credential"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"(self):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"._g_credential\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This simply overwrites the _g_credential instance variable with an instance of a new class, "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"MockGoogleCredential"}]},{"type":"text","value":".\nThat class is defined just above this code as the following:"}]},{"type":"element","tag":"pre","props":{"className":"language-python shiki shiki-themes github-dark","code":"class MockGoogleCredential(credentials.Credentials):\n    \"\"\"A mock Google authentication credential.\"\"\"\n    def refresh(self, request):\n        self.token = 'mock-token'\n\n    @property\n    def service_account_email(self):\n        return 'mock-email'\n","language":"python","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" MockGoogleCredential"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"credentials"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"Credentials"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"    \"\"\"A mock Google authentication credential.\"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" refresh"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"(self, request):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"        self"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":".token "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" 'mock-token'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"    @"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"property\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" service_account_email"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"(self):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" 'mock-email'\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now, we can initialise the Firebase Admin SDK in our app by running the following function:"}]},{"type":"element","tag":"pre","props":{"className":"language-python shiki shiki-themes github-dark","code":"def fake_firebase_init():\n    \"\"\"Fake the Firebase Admin SDK being set up.\"\"\"\n    firebase_admin.initialize_app(MockCredential(), {\"projectId\": \"mock-project-id\"})\n","language":"python","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"def"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" fake_firebase_init"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"():\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"    \"\"\"Fake the Firebase Admin SDK being set up.\"\"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    firebase_admin.initialize_app(MockCredential(), {"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"projectId\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"mock-project-id\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"})\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After running it, Firebase will think it's been successfully initialised, but won't be able to perform any\nauthentication actions - perfect for our requirements."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's all for today, until next time!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Alex"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:posts:2024-11-23-faking-firebase-admin-in-tests.md","_source":"content","_file":"posts/2024-11-23-faking-firebase-admin-in-tests.md","_stem":"posts/2024-11-23-faking-firebase-admin-in-tests","_extension":"md"}