{"_path":"/posts/python-poetry-custom-source-priority","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"Setting Source Priorities In Poetry","description":"How to use a custom source for a package, and ensure that its priority causes the dependency to be managed correctly.","imagesource":"https://www.python.org/community/logos/","imagecredit":"\"Python\" and the Python logos are trademarks or registered trademarks of the Python Software Foundation. Poetry is available under the MIT License.","imageFilename":"2024.08.05-python-poetry-custom-source-priority.png","createdAt":"2024-08-05T17:20:00","updatedAt":"2024-08-05T17:20:00","readingTime":{"text":"3 min read","minutes":2.95,"time":177000,"words":590},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm a big fan of the "},{"type":"element","tag":"a","props":{"href":"https://python-poetry.org/","rel":["nofollow"]},"children":[{"type":"text","value":"Poetry"}]},{"type":"text","value":" dependency management platform for Python, mainly as I've\nfound it almost always to be a dream to work with. As many of its competitors, it wraps pip, venv and other tools with\na unified front-end, and gets rid of the need to roll custom setup.py files (ew, right?). Often when we're working with\na really simple application, just a requirements.txt file will do fine, and nothing more complex is required. When we\nneed to do complex stuff is where these tools really shine."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I recently found that I was unable to install "},{"type":"element","tag":"a","props":{"href":"https://github.com/AppImageCrafters/appimage-builder","rel":["nofollow"]},"children":[{"type":"text","value":"appimage-builder"}]},{"type":"text","value":"\ndue to it having a dependency on "},{"type":"element","tag":"a","props":{"href":"https://github.com/lief-project/LIEF","rel":["nofollow"]},"children":[{"type":"text","value":"LIEF"}]},{"type":"text","value":", which in the ppublished version was (and\nstill is to the date I'm publishing this), segfaulting when parsing aarch64 binaries. After testing the nightly LIEF\nbuild, I found that it no longer segfaulted, so I needed to figure out how to use that release instead of the version\n"},{"type":"element","tag":"a","props":{"href":"https://pypi.org/project/lief/","rel":["nofollow"]},"children":[{"type":"text","value":"available on PyPI"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The source repository for the nightly version is stated as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"https://lief.s3-website.fr-par.scw.cloud/latest/lief"}]},{"type":"text","value":". The\nfirst thing to do here is to add that into our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pyproject.toml"}]},{"type":"text","value":" as a custom repository. We can do this manually, or by\nusing the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"poetry"}]},{"type":"text","value":" CLI as follows:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"poetry source add --priority=explicit lief-nightly https://lief.s3-website.fr-par.scw.cloud/latest/lief\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"poetry"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" source"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" add"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --priority=explicit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" lief-nightly"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" https://lief.s3-website.fr-par.scw.cloud/latest/lief\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will create the following stanza in our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pyproject.toml"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"className":"language-toml shiki shiki-themes github-dark","code":"[[tool.poetry.source]]\nname = \"lief-nightly\"\nurl = \"https://lief.s3-website.fr-par.scw.cloud/latest\"\npriority = \"explicit\"\n","language":"toml","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"[["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"tool"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"poetry"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"source"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"]]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"name = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"lief-nightly\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"url = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"https://lief.s3-website.fr-par.scw.cloud/latest\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"priority = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"explicit\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Poetry repositories can be "},{"type":"element","tag":"a","props":{"href":"https://python-poetry.org/docs/repositories/#primary-package-sources","rel":["nofollow"]},"children":[{"type":"text","value":"primary"}]},{"type":"text","value":",\n"},{"type":"element","tag":"a","props":{"href":"https://python-poetry.org/docs/repositories/#supplemental-package-sources","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"supplemental"}]}]},{"type":"text","value":" or\n"},{"type":"element","tag":"a","props":{"href":"https://python-poetry.org/docs/repositories/#explicit-package-sources","rel":["nofollow"]},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"explicit"}]}]},{"type":"text","value":". A repository created without a\npriority is considered to be primary, otherwise we need to specify it in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"priority"}]},{"type":"text","value":" TOML key. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"primary"}]},{"type":"text","value":" can also\nmanually be specified as the priority if preferred."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Primary repositories are meant to be the default places where pip will look for dependencies. Because we have no\ncontrol over which packages get published to this repository, this is clearly not the option we're looking for, as this\ncould cause dependencies otherwise available in PyPI to be overridden."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Supplemental repositories are only searched if no package was found in the primary repositories. This is better, but\nagain opens a potential risk of installing packages from places we may not be expecting. So I went with the third\noption:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"explicit"}]},{"type":"text","value":" priority means that we define within the dependency's specification which repository it must come from. That\nway, we can be even more certain that we are getting only the exact package(s) we want from the repository. This is by\nfar the most useful option for third-party repositories that we don't control ourselves."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Because we've chosen "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"explicit"}]},{"type":"text","value":" priority, we need to specify the repository's name in the dependency. The simplest\noption here is just to use the Poetry CLI, because it'll ensure that the lockfile is updated."}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"poetry add --source lief-nightly lief==0.16.0.dev0\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"poetry"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" add"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" --source"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" lief-nightly"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" lief==0.16.0.dev0\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will create the following line in our "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pyproject.toml"}]},{"type":"text","value":"'s main dependencies section':"}]},{"type":"element","tag":"pre","props":{"className":"language-toml shiki shiki-themes github-dark","code":"lief = { version = \"0.16.0.dev0\", source = \"lief-nightly\" }\n","language":"toml","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"lief = { version = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"0.16.0.dev0\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", source = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"lief-nightly\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" }\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I always like to add a comment to overridden dependencies to explain why they're necessary, so I changed that to the\nfollowing:"}]},{"type":"element","tag":"pre","props":{"className":"language-toml shiki shiki-themes github-dark","code":"# We use LIEF nightly because the latest (0.15.1) segfaults on parsing aarch64 binaries.\n# To check again when the next version is released.\nlief = { version = \"0.16.0.dev0\", source = \"lief-nightly\" }\n","language":"toml","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"# We use LIEF nightly because the latest (0.15.1) segfaults on parsing aarch64 binaries.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D"},"children":[{"type":"text","value":"# To check again when the next version is released.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"lief = { version = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"0.16.0.dev0\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", source = "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"\"lief-nightly\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" }\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We could just use \"*\" as the version, and let Poetry do its thing every time we update, but because I want to regularly\ncheck the PyPI version to see if the issue has been fixed yet, I wanted it to notify me when the next dev version has\nbeen released."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That's all we need to do. You can now check your lockfile to ensure that the dependency chain has been updated\ncorrectly, and if you're using appimage-builder on aarch64, your builds will now work!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Until the next post!"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Alex"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:posts:2024-08-05-python-poetry-custom-source-priority.md","_source":"content","_file":"posts/2024-08-05-python-poetry-custom-source-priority.md","_stem":"posts/2024-08-05-python-poetry-custom-source-priority","_extension":"md"}