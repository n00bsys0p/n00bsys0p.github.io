{"_path":"/posts/changing-foremans-ssl-certificate","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"Changing The Foreman's SSL Certificate","description":"How to change The Foreman's web UI SSL certificate without affecting your Puppet nodes.","imagesource":"https://commons.wikimedia.org/wiki/File:QV_Building_construction_site,_Melbourne_-_March_2002.jpg","imagecredit":"Diliff","imageFilename":"2015.09.24T060000_changing-foremans-ssl-certificate.jpg","createdAt":"2015-09-24T06:00:00","updatedAt":"2015-09-24T06:00:00","readingTime":{"text":"1 min read","minutes":0.1,"time":6000,"words":20},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I spent a number of hours today trying to work out how to do what I thought would be a fairly simple task: change the SSL certificates for a Foreman install that was originally configured using the default settings. Doing so turned out to be the source of some tearing of hair, so I’ve documented the process."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"What I was trying to do is update a "},{"type":"element","tag":"a","props":{"href":"http://theforeman.org/"},"children":[{"type":"text","value":"Foreman"}]},{"type":"text","value":" instance to use a trusted SSL certificate for the\nweb UI, but NOT change any of the Puppet certs. Foreman by default serves the web UI\nusing Puppet’s SSL cert, which is self-signed and therefore most likely not trusted by the\nmajority of browsers. While this doesn’t make the certificate any less technically secure,\nhaving to have your staff manually check the certificate’s validity before adding an exception\nis at best an unnecessary annoyance."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I originally installed the node using "},{"type":"element","tag":"a","props":{"href":"http://theforeman.org/manuals/1.1/index.html#3.2ForemanInstaller"},"children":[{"type":"text","value":"foreman-installer"}]},{"type":"text","value":", so had my answers file located in\n/etc/foreman/foreman-installer-answers.yaml. This has tons of settings, not many of which\nare particularly well documented. After a little digging, it turned out that foreman-installer is a\npretty thin wrapper for "},{"type":"element","tag":"a","props":{"href":"https://github.com/theforeman/kafo"},"children":[{"type":"text","value":"kafo"}]},{"type":"text","value":", a rubygem that allows masterless application of\nYAML-configured Puppet modules. This means that the answers file can effectively be\ntreated as something pretty similar to a hieradata configuration file."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By running a simple regex search on the answers file, we can get a hugely reduced list of\nsettings to investigate. Run the following command:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark","code":"grep -E \"^\\s+(puppet|server)_ssl_\" /etc/foreman/foreman-installer-answers.yaml\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":"grep"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" -E"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"^\\s+(puppet|server)_ssl_\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" /etc/foreman/foreman-installer-answers.yaml\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This will output something like the following:"}]},{"type":"element","tag":"pre","props":{"className":"language-yaml shiki shiki-themes github-dark","code":"puppet_ssl_cert: /var/lib/puppet/ssl/certs/foreman.example.com.pem\npuppet_ssl_ca: /var/lib/puppet/ssl/certs/ca.pem\npuppet_ssl_key: /var/lib/puppet/ssl/private_keys/foreman.example.com.pem\nserver_ssl_dir: /var/lib/puppet/ssl\nserver_ssl_cert: /var/lib/puppet/ssl/certs/foreman.example.com.pem\nserver_ssl_crl:\nserver_ssl_chain: /var/lib/puppet/ssl/ca/signed/foreman.example.com.pem\nserver_ssl_ca: /var/lib/puppet/ssl/certs/ca.pem\nserver_ssl_key: /var/lib/puppet/ssl/private_keys/foreman.example.com.pem\n","language":"yaml","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"puppet_ssl_cert"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/certs/foreman.example.com.pem\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"puppet_ssl_ca"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/certs/ca.pem\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"puppet_ssl_key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/private_keys/foreman.example.com.pem\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"server_ssl_dir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"server_ssl_cert"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/certs/foreman.example.com.pem\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"server_ssl_crl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"server_ssl_chain"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/ca/signed/foreman.example.com.pem\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"server_ssl_ca"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/certs/ca.pem\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#85E89D"},"children":[{"type":"text","value":"server_ssl_key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"/var/lib/puppet/ssl/private_keys/foreman.example.com.pem\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In order to swap out the web UI’s SSL certificate, we need to update 4 of these settings; 3 of\nthem relating to Foreman (server_ prefix), and one related to Puppet (puppet_ prefix):"}]},{"type":"element","tag":"h3","props":{"id":"server_ssl_cert"},"children":[{"type":"text","value":"server_ssl_cert"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This should be set to your signed certificate file’s location. It’s used to configure\nSSLCertificateFile in /etc/httpd/conf.d/05-foreman-ssl.conf. In my case I put the file in\n/etc/httpd/certs, meaning I set this to /etc/httpd/certs/foreman.mydomain.com.crt"}]},{"type":"element","tag":"h3","props":{"id":"server_ssl_chain"},"children":[{"type":"text","value":"server_ssl_chain"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This needs to be set to your SSL provider’s CA chain file. It’s used to configure\nSSLCertificateChainFile in Foreman’s SSL virtualhost. You may get this with your\ncertificates, but in my case the one supplied with the certificate was a chain that only led\nback to one of their intermediate certificates, missing the root. If this is the case, you may\nneed to find the root on their website. To confirm you’ve got the correct certificate chain\nbefore starting, you can use the "},{"type":"element","tag":"a","props":{"href":"https://github.com/Katello/katello-installer/blob/master/bin/katello-certs-check"},"children":[{"type":"text","value":"Katello installer’s certificate checker"}]},{"type":"text","value":" (this also works for a\npure Foreman install)."}]},{"type":"element","tag":"h3","props":{"id":"server_ssl_key"},"children":[{"type":"text","value":"server_ssl_key"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This needs to point at your SSL private key file. It configures SSLCertificateKeyFile in the\nForeman SSL vhost. I placed this file in /etc/httpd/certs (be careful with file access\npermissions), so my line looked something like ‘/etc/httpd/certs/foreman.mydomain.com.key’."}]},{"type":"element","tag":"h3","props":{"id":"puppet_ssl_ca"},"children":[{"type":"text","value":"puppet_ssl_ca"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This setting is really important to get right. If you miss it, the web UI will work perfectly after you run the foreman-installer, but your Foreman Hosts won’t be able to connect to the\nPuppet proxy. It needs to be set to the same value as we set server_ssl_chain to just above."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When this was set incorrectly, the error I received was “SSL_connect returned=1 errno=0\nstate=SSLv3 read server certificate B: certificate verify failed” on the server, and “Error 400\non SERVER: Failed to find puppet-client-certname-goes-here.mydomain.com via exec:\nExecution of '/etc/puppet/node.rb puppet-client-certname-goes-here.mydomain.com'\nreturned 1:”"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once you’ve modified these lines, you need to re-run foreman-installer, which will pick up the\nanswers file automatically. Take care before starting it that you haven’t made changes to the\nsystem manually that will be overwritten by doing so - if you have, persist them into the\nanswers file before starting."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When it’s finished, navigating back to your foreman domain in a web browser\nshould prove it’s all worked. Right click the lock icon on the address bar and you can confirm\nthat it’s been signed by the expected trusted authority. You should also ensure that your\nPuppet clients can connect successfully. You can do this by running this command on the\nForeman instance: “/etc/puppet/node.rb puppet-client-certname.mydomain.com”, where certname.mydomain.com is an existing Puppet certname."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That should be all you need to get up and running!"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"server_ssl_cert","depth":3,"text":"server_ssl_cert"},{"id":"server_ssl_chain","depth":3,"text":"server_ssl_chain"},{"id":"server_ssl_key","depth":3,"text":"server_ssl_key"},{"id":"puppet_ssl_ca","depth":3,"text":"puppet_ssl_ca"}]}},"_type":"markdown","_id":"content:posts:2015-09-24-changing-foremans-ssl-certificate.md","_source":"content","_file":"posts/2015-09-24-changing-foremans-ssl-certificate.md","_stem":"posts/2015-09-24-changing-foremans-ssl-certificate","_extension":"md"}